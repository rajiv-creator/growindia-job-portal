<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrowIndia — Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;padding:24px;background:#f6f7fb;color:#111}
    h1{margin:0 0 8px}
    .muted{color:#666;margin:0 0 24px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h2{font-size:16px;margin:0;padding:12px 16px;border-bottom:1px solid #eee}
    .pad{padding:12px 16px}
    table{width:100%;border-collapse:collapse}
    th,td{font-size:14px;padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    th{background:#fafafa}
    .count-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:0 0 16px}
    .pill{display:flex;flex-direction:column;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    .pill .label{font-size:12px;color:#666}
    .pill .num{font-size:20px;font-weight:600}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .link{color:#2563eb;text-decoration:none}
    .link:hover{text-decoration:underline}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.count-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
  <div class="toolbar">
    <div>
      <h1>Admin</h1>
      <p class="muted">Private reports & raw tables (read-only)</p>
    </div>
    <div><a class="link" href="/">← Back to site</a></div>
  </div>

  <!-- Quick counts -->
  <div class="count-grid" id="counts">
    <div class="pill"><div class="label">Total jobs</div>        <div class="num" id="c_total_jobs">–</div></div>
    <div class="pill"><div class="label">Active jobs</div>       <div class="num" id="c_active_jobs">–</div></div>
    <div class="pill"><div class="label">Closed jobs</div>       <div class="num" id="c_closed_jobs">–</div></div>
    <div class="pill"><div class="label">Featured jobs</div>     <div class="num" id="c_featured_jobs">–</div></div>
    <div class="pill"><div class="label">Total companies</div>   <div class="num" id="c_total_companies">–</div></div>
    <div class="pill"><div class="label">Total applications</div><div class="num" id="c_total_apps">–</div></div>
    <div class="pill"><div class="label">Pending apps</div>      <div class="num" id="c_pending_apps">–</div></div>
    <div class="pill"><div class="label">Reviewed apps</div>     <div class="num" id="c_reviewed_apps">–</div></div>
    <div class="pill"><div class="label">Shortlisted apps</div>  <div class="num" id="c_shortlisted_apps">–</div></div>
    <div class="pill"><div class="label">Hired apps</div>        <div class="num" id="c_hired_apps">–</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Jobs</h2>
      <div class="pad"><div id="tbl_jobs">Loading…</div></div>
    </div>
    <div class="card">
      <h2>Applications</h2>
      <div class="pad"><div id="tbl_apps">Loading…</div></div>
    </div>
    <div class="card">
      <h2>Companies</h2>
      <div class="pad"><div id="tbl_companies">Loading…</div></div>
    </div>
    <div class="card">
      <h2>Accounts</h2>
      <div class="pad"><div id="tbl_profiles">Loading…</div></div>
    </div>
  </div>

  <!-- Load scripts (keep this ORDER) -->
  <script src="config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>

  <!-- Admin allow-list guard + loaders -->
  <script>
    // 1) SAME allow-list here and in app.js
    const ADMIN_EMAILS = ['rajiv.growindia1@gmail.com'];

    // 2) Guard the page (kicks non-admins away)
    supabase.auth.onAuthStateChange(async (_e, session) => {
      const email = session?.user?.email;
      if (!email || !ADMIN_EMAILS.includes(email)) location.href = '/';
    });
    (async () => { // immediate check on first paint (no flicker)
      const { data: { user } } = await supabase.auth.getUser();
      if (!user || !ADMIN_EMAILS.includes(user.email)) location.href = '/';
    })();

    // --- tiny helpers
    function el(id){ return document.getElementById(id); }
    function renderTable(targetId, rows, columns){
      const host = el(targetId);
      if (!rows || rows.length === 0){ host.innerHTML = '<em>No data</em>'; return; }
      const thead = '<thead><tr>' + columns.map(c => `<th>${c.label}</th>`).join('') + '</tr></thead>';
      const tbody = '<tbody>' + rows.map(r => (
        '<tr>' + columns.map(c => `<td>${(r[c.key] ?? '')}</td>`).join('') + '</tr>'
      )).join('') + '</tbody>';
      host.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    // --- fetch & render counts (from v_admin_counts)
    async function loadCounts(){
      const { data, error } = await supabase.from('v_admin_counts').select('*').single();
      if (error){ console.error(error); return; }
      for (const k of Object.keys(data)){
        const target = document.getElementById('c_' + k);
        if (target) target.textContent = data[k];
      }
    }

    // --- fetch four tables (views)
    async function loadTables(){
      // Jobs
      let r = await supabase.from('v_job_public')
        .select('id,title,company_name,location,status,featured,created_at')
        .order('created_at', { ascending:false }).limit(25);
      if (!r.error){
        renderTable('tbl_jobs', r.data, [
          {key:'id',label:'ID'}, {key:'title',label:'Title'}, {key:'company_name',label:'Company'},
          {key:'location',label:'Location'}, {key:'status',label:'Status'},
          {key:'featured',label:'Featured'}, {key:'created_at',label:'Created'}
        ]);
      }

      // Applications
      r = await supabase.from('applications')
        .select('id,job_id,applicant_id,status,created_at').order('created_at',{ascending:false}).limit(25);
      if (!r.error){
        renderTable('tbl_apps', r.data, [
          {key:'id',label:'ID'}, {key:'job_id',label:'Job'}, {key:'applicant_id',label:'Applicant'},
          {key:'status',label:'Status'}, {key:'created_at',label:'Applied'}
        ]);
      }

      // Companies
      r = await supabase.from('companies')
        .select('id,name,website,owner_id,created_at').order('created_at',{ascending:false}).limit(25);
      if (!r.error){
        renderTable('tbl_companies', r.data, [
          {key:'id',label:'ID'}, {key:'name',label:'Name'}, {key:'website',label:'Website'},
          {key:'owner_id',label:'Owner'}, {key:'created_at',label:'Created'}
        ]);
      }

      // Accounts (profiles)
      r = await supabase.from('profiles')
        .select('id,full_name,email,role,created_at').order('created_at',{ascending:false}).limit(25);
      if (!r.error){
        renderTable('tbl_profiles', r.data, [
          {key:'id',label:'ID'}, {key:'full_name',label:'Name'}, {key:'email',label:'Email'},
          {key:'role',label:'Role'}, {key:'created_at',label:'Created'}
        ]);
      }
    }

    loadCounts();
    loadTables();
  </script>
</body>
</html>
