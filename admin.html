<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia — Admin</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="app.js"></script>
  <style>
    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .side{background:var(--panel);border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh}
    .side h3{margin:0 0 12px 0}
    .navlink{display:block;padding:10px 12px;border-radius:10px;margin-bottom:6px;border:1px solid transparent;color:var(--ink);cursor:pointer}
    .navlink.active{background:#eef2ff;border-color:#c7d2fe}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:var(--panel);border-bottom:1px solid var(--line)}
    .pill{padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1e40af;font-size:12px}
    .row.gap6{gap:6px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media(max-width:1100px){ .layout{grid-template-columns:1fr} .side{position:static;height:auto} .two,.three{grid-template-columns:1fr} }
    .muted{color:var(--muted)}
    .table-actions button{margin-right:6px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand">GrowIndia — Admin</div>
  <div class="row gap6">
    <a class="btn ghost" href="index.html">Public Jobs</a>
    <button id="logoutBtn" class="btn ghost">Logout</button>
  </div>
</div>

<div class="layout">
  <aside class="side">
    <h3>Manage</h3>
    <a class="navlink active" data-section="companies">Companies</a>
    <a class="navlink" data-section="jobs">Jobs</a>
    <a class="navlink" data-section="applications">Applications</a>
    <a class="navlink" data-section="lookups">Lookups</a>
    <a class="navlink" data-section="settings">Settings</a>
    <hr style="border-color:var(--line);margin:12px 0"/>
    <div id="me" class="muted" style="font-size:12px"></div>
  </aside>

  <main class="container">

    <!-- COMPANIES -->
    <section id="companies">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h1>Companies</h1>
          <button id="newCompanyBtn" class="btn">New Company</button>
        </div>
        <div id="companyList"></div>
      </div>

      <div class="card" id="companyFormCard" style="display:none">
        <h2 id="companyFormTitle">Create Company</h2>
        <input type="hidden" id="c_id" />
        <label>Name</label>
        <input id="c_name" placeholder="Acme Inc"/>
        <label>Website</label>
        <input id="c_website" placeholder="https://example.com"/>
        <div class="row">
          <button id="saveCompany" class="btn">Save</button>
          <button id="cancelCompany" class="btn ghost">Cancel</button>
        </div>
      </div>
    </section>

    <!-- JOBS -->
    <section id="jobs" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h1>Jobs</h1>
          <button id="newJobBtn" class="btn">Post Job</button>
        </div>

        <div class="toolbar">
          <label class="muted">With selected:</label>
          <button class="btn warn" id="bulkActive">Activate</button>
          <button class="btn warn" id="bulkDraft">Draft</button>
          <button class="btn warn" id="bulkClosed">Close</button>
          <button class="btn bad"  id="bulkDelete">Delete</button>
        </div>

        <div id="jobsTable"></div>
      </div>

      <div class="card" id="jobFormCard" style="display:none">
        <h2 id="jobFormTitle">Post Job</h2>
        <input type="hidden" id="j_id" />
        <label>Company</label>
        <select id="j_company"></select>

        <div class="two">
          <div>
            <label>Title</label>
            <input id="j_title" placeholder="Senior React Developer"/>
          </div>
          <div>
            <label>Status</label>
            <select id="j_status"><option>Active</option><option>Draft</option><option>Closed</option></select>
          </div>
        </div>

        <label>Description</label>
        <textarea id="j_desc" rows="6" placeholder="Role, responsibilities, requirements..."></textarea>

        <div class="three">
          <div>
            <label>Industry</label>
            <select id="j_industry"></select>
          </div>
          <div>
            <label>Job Type</label>
            <select id="j_jobtype"></select>
          </div>
          <div>
            <label>Seniority Level</label>
            <select id="j_level"></select>
          </div>
        </div>

        <div class="three">
          <div>
            <label>Location</label>
            <select id="j_location"></select>
          </div>
          <div>
            <label>Employment</label>
            <select id="j_emp">
              <option>full_time</option>
              <option>part_time</option>
              <option>contract</option>
              <option>internship</option>
            </select>
          </div>
          <div>
            <label>Remote?</label>
            <select id="j_remote"><option value="true">Yes</option><option value="false">No</option></select>
          </div>
        </div>

        <div class="three">
          <div>
            <label>Salary Min</label>
            <input id="j_smin" type="number" placeholder="500000"/>
          </div>
          <div>
            <label>Salary Max</label>
            <input id="j_smax" type="number" placeholder="1500000"/>
          </div>
          <div>
            <label>Currency</label>
            <select id="j_curr"><option>INR</option><option>USD</option><option>EUR</option><option>GBP</option><option>AED</option></select>
          </div>
        </div>

        <div class="row">
          <button id="saveJob" class="btn">Save</button>
          <button id="cancelJob" class="btn ghost">Cancel</button>
        </div>
      </div>
    </section>

    <!-- APPLICATIONS -->
    <section id="applications" style="display:none">
      <div class="card">
        <h1>Applications</h1>

        <div class="toolbar">
          <label class="muted">With selected → Status:</label>
          <select id="bulkAppStatus">
            <option>pending</option><option>reviewed</option><option>shortlisted</option><option>rejected</option><option>hired</option>
          </select>
          <button id="applyBulkAppStatus" class="btn">Apply</button>
        </div>

        <div id="appsTable"></div>
      </div>
    </section>

    <!-- LOOKUPS -->
    <section id="lookups" style="display:none">
      <div class="card">
        <h1>Lookups</h1>
        <p class="muted">These control dropdowns in the job form. Add your own values, delete the ones you don’t use.</p>
      </div>

      <div class="card" id="lkIndustries"></div>
      <div class="card" id="lkJobTypes"></div>
      <div class="card" id="lkLevels"></div>
      <div class="card" id="lkLocations"></div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" style="display:none">
      <div class="card">
        <h1>Settings</h1>
        <p class="muted">More controls (members, branding, email templates) can come next.</p>
        <div class="row">
          <a class="btn ghost" href="dashboard.html">Old Dashboard</a>
          <a class="btn ghost" href="index.html">Public Jobs</a>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
  // --- nav ---
  document.querySelectorAll('.navlink').forEach(a=>{
    a.onclick = () => {
      document.querySelectorAll('.navlink').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const id=a.dataset.section;
      ['companies','jobs','applications','lookups','settings'].forEach(s=>{
        document.getElementById(s).style.display = (s===id?'':'none');
      });
    };
  });

  // --- auth ---
  const meEl = document.getElementById('me');
  document.getElementById('logoutBtn').onclick = () => sbAuth.signOut();

  // --- refs ---
  const companyList = document.getElementById('companyList');
  const newCompanyBtn = document.getElementById('newCompanyBtn');
  const companyFormCard = document.getElementById('companyFormCard');
  const companyFormTitle = document.getElementById('companyFormTitle');
  const c_id=document.getElementById('c_id'), c_name=document.getElementById('c_name'), c_website=document.getElementById('c_website');
  const saveCompany=document.getElementById('saveCompany'), cancelCompany=document.getElementById('cancelCompany');

  const jobsTable=document.getElementById('jobsTable');
  const newJobBtn=document.getElementById('newJobBtn');
  const jobFormCard=document.getElementById('jobFormCard'), jobFormTitle=document.getElementById('jobFormTitle');
  const j_id=document.getElementById('j_id'), j_company=document.getElementById('j_company'), j_title=document.getElementById('j_title'), j_desc=document.getElementById('j_desc');
  const j_industry=document.getElementById('j_industry'), j_jobtype=document.getElementById('j_jobtype'), j_level=document.getElementById('j_level'), j_location=document.getElementById('j_location');
  const j_emp=document.getElementById('j_emp'), j_smin=document.getElementById('j_smin'), j_smax=document.getElementById('j_smax'), j_curr=document.getElementById('j_curr'), j_remote=document.getElementById('j_remote'), j_status=document.getElementById('j_status');
  const saveJob=document.getElementById('saveJob'), cancelJob=document.getElementById('cancelJob');

  const appsTable=document.getElementById('appsTable');
  const bulkAppStatus=document.getElementById('bulkAppStatus'), applyBulkAppStatus=document.getElementById('applyBulkAppStatus');

  // lookups containers
  const lkIndustries=document.getElementById('lkIndustries');
  const lkJobTypes=document.getElementById('lkJobTypes');
  const lkLevels=document.getElementById('lkLevels');
  const lkLocations=document.getElementById('lkLocations');

  let USER=null; let COMPANIES=[]; let LOOKUPS={industries:[],jobTypes:[],levels:[],locations:[]};

  function toast(m){ alert(m) }
  const num = v => v?Number(v):null;
  const truthy = v => v==='true';

  async function boot(){
    USER = await sbAuth.currentUser();
    if(!USER){ alert('Please login first.'); window.location.href='index.html'; return }
    meEl.innerHTML = `<div><span class="pill">Signed in</span> ${USER.email||USER.id}</div>`;

    LOOKUPS = await sbData.getLookups();
    await loadCompanies(); await loadJobs(); await loadApps();
    renderLookups();
  }

  // -------- Companies --------
  function resetCompanyForm(){ c_id.value=''; c_name.value=''; c_website.value='' }
  newCompanyBtn.onclick=()=>{ resetCompanyForm(); companyFormTitle.textContent='Create Company'; companyFormCard.style.display='' }
  cancelCompany.onclick=()=>{ companyFormCard.style.display='none' }

  async function loadCompanies(){
    const { data, error } = await sb.supabase.from('companies').select('id,name,website,created_at').eq('owner_id', USER.id).order('created_at',{ascending:false});
    if(error){ companyList.innerHTML = '<div class="card">Error: '+error.message+'</div>'; return }
    COMPANIES = data||[];
    renderCompanies(); fillCompanySelect();
  }

  function renderCompanies(){
    if(!COMPANIES.length){ companyList.innerHTML='<div class="card">No companies yet. Click “New Company”.</div>'; return }
    const rows = COMPANIES.map(c=>`
      <tr>
        <td>${c.name}</td>
        <td>${c.website || ''}</td>
        <td>${(c.created_at||'').slice(0,10)}</td>
        <td class="table-actions">
          <button class="btn" data-edit="${c.id}">Edit</button>
          <button class="btn bad" data-del="${c.id}">Delete</button>
        </td>
      </tr>`).join('');
    companyList.innerHTML = `<table class="table"><thead><tr><th>Name</th><th>Website</th><th>Created</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    companyList.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>editCompany(b.dataset.edit));
    companyList.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>deleteCompany(b.dataset.del));
  }

  function fillCompanySelect(){
    j_company.innerHTML = '';
    (COMPANIES||[]).forEach(c=>{
      const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; j_company.appendChild(o);
    });
  }

  async function editCompany(id){
    const c = COMPANIES.find(x=>x.id===id); if(!c) return;
    c_id.value=c.id; c_name.value=c.name; c_website.value=c.website||'';
    companyFormTitle.textContent='Edit Company'; companyFormCard.style.display='';
  }
  async function deleteCompany(id){
    if(!confirm('Delete this company and all its jobs?')) return;
    const { error } = await sb.supabase.from('companies').delete().eq('id', id);
    if(error){ toast(error.message); return }
    await loadCompanies(); await loadJobs(); toast('Deleted.');
  }
  saveCompany.onclick=async()=>{
    if(!c_name.value.trim()) return toast('Company name is required.');
    const payload = { name: c_name.value.trim(), website: c_website.value.trim()||null, owner_id: USER.id };
    if(c_id.value){
      const { error } = await sb.supabase.from('companies').update(payload).eq('id', c_id.value);
      if(error) return toast(error.message);
    }else{
      const body={ id: crypto.randomUUID(), ...payload };
      const { error } = await sb.supabase.from('companies').insert(body);
      if(error) return toast(error.message);
    }
    companyFormCard.style.display='none'; resetCompanyForm();
    await loadCompanies(); toast('Saved.');
  }

  // -------- Jobs --------
  function resetJobForm(){
    j_id.value=''; if(COMPANIES[0]) j_company.value=COMPANIES[0].id;
    j_title.value=''; j_desc.value='';
    fillSelect(j_industry, LOOKUPS.industries);
    fillSelect(j_jobtype, LOOKUPS.jobTypes);
    fillSelect(j_level, LOOKUPS.levels);
    fillSelect(j_location, LOOKUPS.locations);
    j_emp.value='full_time'; j_smin.value=''; j_smax.value=''; j_curr.value='INR'; j_remote.value='true'; j_status.value='Active';
  }
  function fillSelect(sel, arr){
    sel.innerHTML='';
    (arr||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o) });
  }
  newJobBtn.onclick=()=>{ resetJobForm(); jobFormTitle.textContent='Post Job'; jobFormCard.style.display='' }
  cancelJob.onclick=()=>{ jobFormCard.style.display='none' }

  async function loadJobs(){
    const { data, error } = await sb.supabase
      .from('jobs')
      .select('id,title,location,employment,currency,salary_min,salary_max,status,industry,job_type,level,created_at,companies!inner(id,name,owner_id)')
      .eq('companies.owner_id', USER.id)
      .order('created_at',{ascending:false});
    if(error){ jobsTable.innerHTML='<div class="card">Error: '+error.message+'</div>'; return }
    renderJobs(data||[]);
  }

  function renderJobs(rows){
    if(!rows.length){ jobsTable.innerHTML='<div class="card">No jobs yet. Click “Post Job”.</div>'; return }
    const html = rows.map(j=>`
      <tr>
        <td><input type="checkbox" class="jobChk" value="${j.id}"/></td>
        <td><strong>${j.title}</strong><br><small class="muted">${j.companies?.name||''}</small></td>
        <td>${j.industry||''}</td>
        <td>${j.job_type||''}</td>
        <td>${j.level||''}</td>
        <td>${j.location||''}</td>
        <td>${j.employment||''}</td>
        <td>${j.currency||''} ${j.salary_min||''}${j.salary_max?(' - '+j.salary_max):''}</td>
        <td><span class="badge">${j.status}</span></td>
        <td class="table-actions">
          <button class="btn" data-edit="${j.id}">Edit</button>
          <button class="btn bad" data-del="${j.id}">Delete</button>
        </td>
      </tr>
    `).join('');
    jobsTable.innerHTML = `<table class="table">
      <thead>
        <tr><th><input type="checkbox" id="jobChkAll"/></th><th>Job</th><th>Industry</th><th>Type</th><th>Level</th><th>Location</th><th>Employment</th><th>Salary</th><th>Status</th><th>Actions</th></tr>
      </thead><tbody>${html}</tbody></table>`;
    document.getElementById('jobChkAll').onclick = (e)=>{
      document.querySelectorAll('.jobChk').forEach(ch=>ch.checked=e.target.checked);
    };
    jobsTable.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>editJob(b.dataset.edit));
    jobsTable.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>deleteJob(b.dataset.del));
  }

  async function editJob(id){
    const { data, error } = await sb.supabase.from('jobs').select('*').eq('id', id).single();
    if(error){ toast(error.message); return }
    resetJobForm();
    j_id.value=data.id; j_company.value=data.company_id;
    j_title.value=data.title||''; j_desc.value=data.description||'';
    ensureOption(j_industry, data.industry); j_industry.value=data.industry||'';
    ensureOption(j_jobtype, data.job_type); j_jobtype.value=data.job_type||'';
    ensureOption(j_level, data.level); j_level.value=data.level||'';
    ensureOption(j_location, data.location); j_location.value=data.location||'';
    j_emp.value=data.employment||'full_time'; j_smin.value=data.salary_min||''; j_smax.value=data.salary_max||''; j_curr.value=data.currency||'INR'; j_remote.value=String(!!data.is_remote); j_status.value=data.status||'Active';
    jobFormTitle.textContent='Edit Job'; jobFormCard.style.display='';
  }
  function ensureOption(sel, val){ if(val && ![...sel.options].some(o=>o.value===val)){ const o=document.createElement('option'); o.value=val; o.textContent=val; sel.appendChild(o) } }

  async function deleteJob(id){
    if(!confirm('Delete this job?')) return;
    const { error } = await sb.supabase.from('jobs').delete().eq('id', id);
    if(error) return toast(error.message);
    await loadJobs();
  }

  async function setJobStatusBulk(ids, status){
    if(!ids.length) return toast('Select at least one job.');
    const { error } = await sb.supabase.from('jobs').update({ status }).in('id', ids);
    if(error) return toast(error.message);
    await loadJobs();
  }
  document.getElementById('bulkActive').onclick = ()=> setJobStatusBulk(selectedJobIds(), 'Active');
  document.getElementById('bulkDraft').onclick  = ()=> setJobStatusBulk(selectedJobIds(), 'Draft');
  document.getElementById('bulkClosed').onclick = ()=> setJobStatusBulk(selectedJobIds(), 'Closed');
  document.getElementById('bulkDelete').onclick = async()=>{
    const ids = selectedJobIds(); if(!ids.length) return toast('Select at least one job.');
    if(!confirm('Delete selected jobs?')) return;
    const { error } = await sb.supabase.from('jobs').delete().in('id', ids);
    if(error) return toast(error.message);
    await loadJobs();
  };
  function selectedJobIds(){ return [...document.querySelectorAll('.jobChk:checked')].map(ch=>ch.value) }

  saveJob.onclick=async()=>{
    if(!j_title.value.trim() || !j_desc.value.trim()) return toast('Title and Description are required.');
    if(!j_company.value) return toast('Select a company.');
    const payload = {
      company_id:j_company.value, title:j_title.value.trim(), description:j_desc.value.trim(),
      location:j_location.value||null, employment:j_emp.value,
      salary_min:num(j_smin.value), salary_max:num(j_smax.value), currency:j_curr.value||'INR',
      is_remote: truthy(j_remote.value), status: j_status.value,
      industry:j_industry.value||null, job_type:j_jobtype.value||null, level:j_level.value||null
    };
    if(j_id.value){
      const { error } = await sb.supabase.from('jobs').update(payload).eq('id', j_id.value);
      if(error) return toast(error.message);
    }else{
      const body={ id: crypto.randomUUID(), ...payload };
      const { error } = await sb.supabase.from('jobs').insert(body);
      if(error) return toast(error.message);
    }
    jobFormCard.style.display='none';
    await loadJobs();
    toast('Saved.');
  }

  // -------- Applications (with bulk status) --------
  async function loadApps(){
    let { data, error } = await sb.supabase.from('v_employer_applications').select('*').order('applied_at',{ascending:false}).limit(500);
    if(error){ appsTable.innerHTML='<div class="card">Error: '+error.message+'</div>'; return }
    renderApps(data||[]);
    // Resolve signed URLs asynchronously after render
    document.querySelectorAll('a[data-resume]').forEach(async a=>{
      const signed = await sbUploads.signedUrlMaybe(a.dataset.resume);
      if(signed){ a.href=signed; a.textContent='Resume'; a.target='_blank' }
      else{ a.textContent='-' }
    });
  }

  function renderApps(rows){
    if(!rows.length){ appsTable.innerHTML='<div class="card">No applications yet.</div>'; return }
    const html = rows.map(r=>`
      <tr>
        <td><input type="checkbox" class="appChk" value="${r.application_id}"/></td>
        <td>${(r.applied_at||'').slice(0,10)}</td>
        <td>${r.applicant_name||''}<br><small class="muted">${r.applicant_email||''}</small></td>
        <td>${r.company_name||''}</td>
        <td>${r.job_title||''}</td>
        <td><span class="badge">${r.application_status}</span></td>
        <td>${r.resume_url?`<a href="#" data-resume="${r.resume_url}">loading…</a>`:'-'}</td>
      </tr>`).join('');
    appsTable.innerHTML = `<table class="table">
      <thead>
        <tr><th><input type="checkbox" id="appChkAll"/></th><th>Date</th><th>Applicant</th><th>Company</th><th>Job</th><th>Status</th><th>Resume</th></tr>
      </thead><tbody>${html}</tbody></table>`;
    document.getElementById('appChkAll').onclick = (e)=>{
      document.querySelectorAll('.appChk').forEach(ch=>ch.checked=e.target.checked);
    };
  }

  applyBulkAppStatus.onclick = async()=>{
    const ids = [...document.querySelectorAll('.appChk:checked')].map(ch=>ch.value);
    if(!ids.length) return toast('Select applications first.');
    const status = bulkAppStatus.value;
    const { error } = await sb.supabase.from('applications').update({ status }).in('id', ids);
    if(error) return toast(error.message);
    await loadApps();
    toast('Updated.');
  };

  // -------- Lookups manager --------
  function renderLookupCard(el, title, table, items){
    el.innerHTML = `
      <h2>${title}</h2>
      <div class="row">
        <input id="${table}New" placeholder="Add new ${title.slice(0,-1)}"/>
        <button class="btn" id="${table}Add">Add</button>
      </div>
      <div style="margin-top:10px">
        ${items.length?`<table class="table"><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody>
          ${items.map(n=>`<tr><td>${n}</td><td><button class="btn bad" data-del="${n}">Delete</button></td></tr>`).join('')}
        </tbody></table>`:'<div class="card">No items yet.</div>'}
      </div>`;
    el.querySelector(`#${table}Add`).onclick = async()=>{
      const v = el.querySelector(`#${table}New`).value.trim();
      if(!v) return;
      const { error } = await sb.supabase.from(table).insert({ name:v });
      if(error) return toast(error.message);
      LOOKUPS = await sbData.getLookups();
      renderLookups(); // re-render all
    };
    el.querySelectorAll('button[data-del]').forEach(b=>b.onclick=async()=>{
      if(!confirm('Delete this value?')) return;
      const { error } = await sb.supabase.from(table).delete().eq('name', b.dataset.del);
      if(error) return toast(error.message);
      LOOKUPS = await sbData.getLookups();
      renderLookups();
    });
  }

  function renderLookups(){
    renderLookupCard(lkIndustries, 'Industries', 'lookup_industries', LOOKUPS.industries);
    renderLookupCard(lkJobTypes,   'Job Types',  'lookup_job_types', LOOKUPS.jobTypes);
    renderLookupCard(lkLevels,     'Seniority Levels', 'lookup_levels', LOOKUPS.levels);
    renderLookupCard(lkLocations,  'Locations',  'lookup_locations', LOOKUPS.locations);
    // refresh job form selects if open
    if(jobFormCard.style.display!=='none'){
      fillSelect(j_industry, LOOKUPS.industries); ensureOption(j_industry, j_industry.value);
      fillSelect(j_jobtype, LOOKUPS.jobTypes);     ensureOption(j_jobtype, j_jobtype.value);
      fillSelect(j_level, LOOKUPS.levels);         ensureOption(j_level, j_level.value);
      fillSelect(j_location, LOOKUPS.locations);   ensureOption(j_location, j_location.value);
    }
  }

  // go!
  boot();
</script>

</body>
</html>

