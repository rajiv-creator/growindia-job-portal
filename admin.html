<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrowIndia — Admin</title>

  <!-- REQUIRED: load SDK first, then your config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=140"></script>

  <style>
    :root { --brand:#2563eb; --text:#0f172a; --muted:#64748b; --bg:#f8fafc; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
         color:var(--text); background:var(--bg); margin:0}
    .nav{display:flex; align-items:center; gap:16px; padding:16px 20px; background:#fff;
         box-shadow:0 1px 0 rgba(15,23,42,.08)}
    .brand{font-weight:700}
    .spacer{flex:1}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e2e8f0}
    .wrap{max-width:1100px;margin:28px auto;padding:0 20px}
    .muted{color:var(--muted)}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:16px 18px;margin:12px 0}
    input{font:inherit;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .row{display:flex; gap:10px; align-items:center}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #e2e8f0;padding:10px 6px;text-align:left;font-size:14px}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">Admin</div>
    <a class="btn ghost" href="index.html">Back to site</a>
    <div class="spacer"></div>
    <span id="who" class="muted">—</span>
    <button id="logoutBtn" class="btn ghost">Logout</button>
  </nav>

  <div class="wrap">
    <h2>Companies</h2>

    <div class="card">
      <div class="row" style="flex-wrap:wrap">
        <input id="cName" placeholder="Company name" style="flex:1; min-width:240px" />
        <input id="cWeb"  placeholder="Website (https://…)" style="flex:1; min-width:260px" />
        <button id="createCompanyBtn" class="btn primary">Create company</button>
      </div>
      <p class="muted" style="margin:10px 0 0">Owner will be the logged-in user.</p>
    </div>

    <div class="card">
      <table>
        <thead><tr><th>Name</th><th>Website</th><th>Owner</th><th>Created</th></tr></thead>
        <tbody id="companiesTbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    // Redirect to post-auth if not signed in
    async function guard(){
      const { data: { session } } = await sbAuth.getSession();
      if(!session){ location.replace('/post-auth.html'); return null; }
      return session;
    }

    async function loadCompanies(){
      const { data, error } = await sb.from('companies')
        .select('id,name,website,owner_id,created_at')
        .order('created_at', { ascending:false })
        .limit(50);
      const tb = document.getElementById('companiesTbody');
      if(error){ console.error(error); tb.innerHTML = `<tr><td colspan="4" class="muted">Failed to load.</td></tr>`; return; }
      if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No rows.</td></tr>`; return; }
      tb.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || ''}</td>
          <td><a href="${r.website || '#'}" target="_blank" rel="noreferrer">${r.website || ''}</a></td>
          <td><code style="font-size:12px">${r.owner_id || ''}</code></td>
          <td>${(r.created_at || '').slice(0,10)}</td>
        </tr>
      `).join('');
    }

    async function createCompany(){
      const name = document.getElementById('cName').value.trim();
      const website = document.getElementById('cWeb').value.trim();
      if(!name){ alert('Enter company name'); return; }
      const { data: { session } } = await sbAuth.getSession();
      if(!session){ alert('You are signed out.'); return; }
      const owner_id = session.user.id; // <- IMPORTANT: non-null

      const { error } = await sb.from('companies').insert([{ name, website, owner_id }]);
      if(error){ alert(error.message); return; }
      document.getElementById('cName').value = '';
      document.getElementById('cWeb').value = '';
      await loadCompanies();
    }

    document.getElementById('logoutBtn').onclick = async () => {
      await sbAuth.signOut(); location.assign('/post-auth.html');
    };
    document.getElementById('createCompanyBtn').onclick = createCompany;

    (async () => {
      const session = await guard();
      if(!session) return;
      document.getElementById('who').textContent = `Signed in as ${session.user.email || session.user.id}`;
      await loadCompanies();
    })();
  </script>
</body>
</html>
