<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia — Admin</title>
  <link rel="icon" href="favicon.ico">
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--b:#e5e7eb;--fg:#111;--muted:#6b7280;
      --blue:#2563eb;--green:#16a34a;--orange:#f59e0b;--red:#dc2626;--sidebar:#0f172a
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:40;background:#0b1220;color:#e5e7eb;display:flex;align-items:center;gap:16px;padding:10px 16px;border-bottom:1px solid #0f1a2b}
    .brand{font-weight:700}
    .topbar input{flex:1;max-width:520px;background:#0f1a2b;border:1px solid #1e2a42;color:#e5e7eb;border-radius:8px;padding:8px 10px}
    .topbar .btn{background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:8px 12px;cursor:pointer}

    /* Sidebar */
    .aside{position:fixed;left:0;top:48px;bottom:0;width:220px;background:var(--sidebar);color:#cbd5e1;border-right:1px solid #0b1220;overflow:auto}
    .aside h3{font-size:12px;text-transform:uppercase;letter-spacing:.06em;margin:16px 12px;color:#7c879c}
    .nav{list-style:none;margin:8px 0 24px;padding:0}
    .nav a{display:flex;align-items:center;gap:10px;color:#cbd5e1;text-decoration:none;padding:8px 12px;border-left:3px solid transparent}
    .nav a:hover{background:#0b1220}
    .nav a.active{background:#0b1220;border-left-color:#3b82f6}

    /* Main */
    .main{margin-left:220px;padding:16px}
    .breadcrumbs{font-size:12px;color:var(--muted);margin-bottom:8px}

    /* KPI cards */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:8px 0 16px}
    .kpi{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:12px 14px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .num{font-size:24px;font-weight:800}

    /* Cards & grids */
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:0 0 16px}
    .card h2{font-size:14px;margin:0;padding:12px 16px;border-bottom:1px solid var(--b);text-transform:uppercase;letter-spacing:.04em;color:#334155}
    .pad{padding:12px 16px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}

    /* Forms & buttons */
    label{display:block;font-size:12px;color:#475569;margin:6px 0 4px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--b);border-radius:8px;font:inherit;background:#fff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--b);background:var(--fg);color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--fg)}
    .btn.sm{font-size:12px;padding:6px 8px;border-radius:6px}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{font-size:14px;padding:8px 10px;border-bottom:1px solid var(--b);text-align:left;vertical-align:top}
    th{background:#f8fafc;color:#475569}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 10px;border:1px solid var(--b);background:#f1f5f9;font-size:12px}
    .error{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px}
    .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;padding:10px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;padding:20px;z-index:50}
    .modal.open{display:grid}
    .modal .box{max-width:960px;width:100%;background:#fff;border-radius:12px;border:1px solid var(--b)}
    .modal .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--b)}
    .modal .bd{padding:12px 16px}
    .modal .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--b)}

    @media (max-width:1100px){
      .aside{position:static;width:auto}
      .main{margin-left:0}
      .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">JobBox</div>
    <input placeholder="Search (ctrl/⌘+k)"/>
    <button class="btn" onclick="location.href='/'">View website</button>
    <div style="margin-left:auto" id="whoami"></div>
  </div>

  <!-- Sidebar -->
  <aside class="aside">
    <h3>Dashboard</h3>
    <nav class="nav">
      <a href="#reports" class="active">Reports</a>
    </nav>

    <h3>Job Board</h3>
    <nav class="nav">
      <a href="#jobs">Jobs</a>
      <a href="#applications">Job Applications</a>
      <a href="#accounts">Accounts</a>
      <a href="#companies">Companies</a>
      <a href="#attributes" onclick="alert('Custom attributes not in schema yet');return false;">Job Attributes</a>
    </nav>

    <h3>Content</h3>
    <nav class="nav">
      <a href="#" onclick="alert('Pages/Blog not wired in DB yet');return false;">Pages</a>
      <a href="#" onclick="alert('Blog not wired in DB yet');return false;">Blog</a>
    </nav>

    <h3>Settings</h3>
    <nav class="nav">
      <a href="#" onclick="alert('Global settings not wired yet');return false;">Platform Administration</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="breadcrumbs">Dashboard / <strong>Reports</strong></div>
    <h1 id="reports">Reports</h1>

    <!-- KPI rows like screenshot -->
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Total Jobs</div><div class="num" id="k_total_jobs">–</div></div>
      <div class="kpi"><div class="label">Active Jobs</div><div class="num" id="k_active_jobs">–</div></div>
      <div class="kpi"><div class="label">Closed Jobs</div><div class="num" id="k_closed_jobs">–</div></div>
      <div class="kpi"><div class="label">Featured Jobs</div><div class="num" id="k_featured_jobs">–</div></div>

      <div class="kpi"><div class="label">Total Applications</div><div class="num" id="k_total_apps">–</div></div>
      <div class="kpi"><div class="label">Pending Applications</div><div class="num" id="k_pending_apps">–</div></div>
      <div class="kpi"><div class="label">Approved Applications</div><div class="num" id="k_approved_apps">–</div></div>
      <div class="kpi"><div class="label">Rejected Applications</div><div class="num" id="k_rejected_apps">–</div></div>

      <div class="kpi"><div class="label">Total Companies</div><div class="num" id="k_total_companies">–</div></div>
      <div class="kpi"><div class="label">Featured Companies</div><div class="num" id="k_featured_companies">–</div></div>
      <div class="kpi"><div class="label">Accounts</div><div class="num" id="k_total_profiles">–</div></div>
      <div class="kpi"><div class="label">Shortlisted</div><div class="num" id="k_shortlisted_apps">–</div></div>
    </div>

    <!-- Charts row -->
    <div class="grid-2">
      <div class="card">
        <h2>Application Trends (Last 30 Days)</h2>
        <div class="pad"><canvas id="ch_apps_30"></canvas></div>
      </div>
      <div class="card">
        <h2>Jobs by Category (Employment)</h2>
        <div class="pad"><canvas id="ch_jobs_emp"></canvas></div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h2>Jobs by Type (Bar)</h2>
        <div class="pad"><canvas id="ch_jobs_type"></canvas></div>
      </div>
      <div class="card">
        <h2>Applications by Location</h2>
        <div class="pad"><canvas id="ch_apps_loc"></canvas></div>
      </div>
    </div>

    <div class="card">
      <h2>Most Applied Jobs</h2>
      <div class="pad"><div id="tbl_top_jobs">Loading…</div></div>
    </div>

    <!-- Companies -->
    <h1 id="companies" style="margin-top:24px">Companies</h1>
    <div class="card">
      <h2>Manage Companies</h2>
      <div class="pad">
        <form id="companyForm" class="grid-3">
          <div><label>Name</label><input id="co_name" required placeholder="Company name"></div>
          <div><label>Website</label><input id="co_site" placeholder="https://…"></div>
          <div><label>Owner email (optional)</label><input id="co_owner_email" placeholder="owner@email.com"></div>
          <div class="row" style="grid-column:1/-1">
            <button class="btn" type="submit">Create company</button>
            <span id="companyMsg" class="muted"></span>
          </div>
        </form>
        <div id="tbl_companies" style="margin-top:12px">Loading…</div>
      </div>
    </div>

    <!-- Jobs -->
    <h1 id="jobs" style="margin-top:24px">Jobs</h1>
    <div class="card">
      <h2>Manage Jobs</h2>
      <div class="pad">
        <div class="row" style="margin-bottom:8px">
          <input id="jobSearch" placeholder="Search title/company/location" style="flex:1">
          <select id="jobStatus">
            <option value="">All statuses</option>
            <option value="active">Active</option>
            <option value="closed">Closed</option>
          </select>
          <select id="jobEmployment">
            <option value="">All employment</option>
            <option value="full_time">full_time</option>
            <option value="part_time">part_time</option>
            <option value="contract">contract</option>
            <option value="internship">internship</option>
          </select>
          <button class="btn sm" id="jobReload">Reload</button>
          <button class="btn sm ghost" id="openCreateJob">+ New job</button>
        </div>
        <div id="tbl_jobs">Loading…</div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Applications -->
      <section>
        <h1 id="applications">Applications</h1>
        <div class="card">
          <h2>All Applications</h2>
          <div class="pad"><div id="tbl_apps">Loading…</div></div>
        </div>
      </section>

      <!-- Accounts -->
      <section>
        <h1 id="accounts">Accounts</h1>
        <div class="card">
          <h2>Profiles</h2>
          <div class="pad"><div id="tbl_profiles">Loading…</div></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Job edit/create modal -->
  <div class="modal" id="jobModal">
    <div class="box">
      <div class="hd">
        <strong id="jobModalTitle">New Job</strong>
        <button class="btn sm ghost" id="closeJobModal">✕</button>
      </div>
      <div class="bd">
        <form id="jobForm">
          <div class="grid-3">
            <div><label>Company</label><select id="jf_company_id" required></select></div>
            <div><label>Title</label><input id="jf_title" required></div>
            <div><label>Location</label><input id="jf_location" placeholder="Remote / City"></div>

            <div><label>Employment</label>
              <select id="jf_employment">
                <option value="full_time">full_time</option>
                <option value="part_time">part_time</option>
                <option value="contract">contract</option>
                <option value="internship">internship</option>
              </select>
            </div>
            <div><label>Remote?</label>
              <select id="jf_is_remote"><option value="true">Yes</option><option value="false">No</option></select>
            </div>
            <div><label>Status</label>
              <select id="jf_status"><option value="active">active</option><option value="closed">closed</option></select>
            </div>

            <div><label>Salary min</label><input id="jf_salary_min" type="number" min="0" step="1"></div>
            <div><label>Salary max</label><input id="jf_salary_max" type="number" min="0" step="1"></div>
            <div><label>Currency</label><input id="jf_currency" placeholder="INR"></div>

            <div class="row" style="align-items:center"><label style="margin:0">Featured</label><input id="jf_featured" type="checkbox" style="width:auto"></div>
          </div>
          <input type="hidden" id="jf_id">
        </form>
        <div id="jobFormMsg" class="muted" style="margin-top:6px"></div>
      </div>
      <div class="ft">
        <button class="btn ghost" id="cancelJob">Cancel</button>
        <button class="btn" id="saveJob">Save</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="config.js?v=10"></script>
  <script src="app.js?v=10"></script>

  <script>
  // Smooth nav highlighting
  document.querySelectorAll('.aside .nav a[href^="#"]').forEach(a=>{
    a.addEventListener('click', () => {
      document.querySelectorAll('.aside .nav a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
    });
  });

  window.addEventListener('load', async () => {
    const sb = (window.sb && window.sb.supabase) ? window.sb.supabase :
      window.supabase.createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON_KEY__, {
        auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}
      });

    const el = id => document.getElementById(id);
    const setK = (k,v)=>{ const t=el('k_'+k); if(t) t.textContent=(v ?? '–'); };
    const renderError=(id,msg)=>{ el(id).innerHTML='<div class="error"><strong>Error:</strong> '+msg+'</div>'; };
    const renderTable=(id,rows,cols)=>{
      const host = el(id);
      if(!rows||rows.length===0){ host.innerHTML='<em>No data</em>'; return; }
      const thead = '<thead><tr>'+cols.map(c=>`<th>${c.label}</th>`).join('')+'</tr></thead>';
      const tbody = '<tbody>'+rows.map(r=>(
        '<tr>'+cols.map(c=>`<td>${(typeof c.render==='function'?c.render(r):(r[c.key]??''))}</td>`).join('')+'</tr>'
      )).join('')+'</tbody>';
      host.innerHTML = `<table>${thead}${tbody}</table>`;
    };

    // Who am I
    const me = await sb.auth.getUser();
    el('whoami').textContent = me.data?.user?.email || '';

    // Guard — admin only
    const rr = await sb.from('profiles').select('role').eq('id', me.data?.user?.id||'').maybeSingle();
    const adminOK = !rr.error && ['admin','super_admin'].includes(String(rr.data?.role||'').toLowerCase());
    if(!adminOK){
      document.body.insertAdjacentHTML('beforeend','<div class="error" style="margin:16px">You are not an admin.</div>');
      return;
    }

    // ---------------- KPI COUNTS ----------------
    async function loadCounts(){
      // Prefer view if present
      const v = await sb.from('v_admin_counts').select('*').maybeSingle();
      if(!v.error && v.data){
        const m=v.data;
        setK('total_jobs', m.total_jobs);
        setK('active_jobs', m.active_jobs);
        setK('closed_jobs', m.closed_jobs);
        setK('featured_jobs', m.featured_jobs);
        setK('total_apps', m.total_apps);
        setK('pending_apps', m.pending_apps);
        setK('approved_apps', m.reviewed_apps ?? m.approved_apps ?? 0);
        setK('rejected_apps', m.rejected_apps ?? 0);
        setK('shortlisted_apps', m.shortlisted_apps ?? 0);
        setK('total_companies', m.total_companies);
      }else{
        // Fallback
        const [
          jobsT, jobsA, jobsC, jobsF,
          appsT, appsP, appsR, appsRej, appsShort,
          compsT
        ] = await Promise.all([
          sb.from('jobs').select('id',{count:'exact',head:true}),
          sb.from('jobs').select('id',{count:'exact',head:true}).eq('status','active'),
          sb.from('jobs').select('id',{count:'exact',head:true}).eq('status','closed'),
          sb.from('jobs').select('id',{count:'exact',head:true}).eq('featured',true),

          sb.from('applications').select('id',{count:'exact',head:true}),
          sb.from('applications').select('id',{count:'exact',head:true}).eq('status','pending'),
          sb.from('applications').select('id',{count:'exact',head:true}).eq('status','reviewed'),
          sb.from('applications').select('id',{count:'exact',head:true}).eq('status','rejected'),
          sb.from('applications').select('id',{count:'exact',head:true}).eq('status','shortlisted'),

          sb.from('companies').select('id',{count:'exact',head:true}),
        ]);
        setK('total_jobs', jobsT.count??'–');
        setK('active_jobs', jobsA.count??'–');
        setK('closed_jobs', jobsC.count??'–');
        setK('featured_jobs', jobsF.count??'–');
        setK('total_apps', appsT.count??'–');
        setK('pending_apps', appsP.count??'–');
        setK('approved_apps', appsR.count??'–');     // "approved" mapped to reviewed
        setK('rejected_apps', appsRej.count??'–');
        setK('shortlisted_apps', appsShort.count??'–');
        setK('total_companies', compsT.count??'–');
      }
      // Featured companies = distinct companies that have a featured job
      const fc = await sb.from('jobs').select('company_id', {distinct:true}).eq('featured', true);
      setK('featured_companies', (fc.data||[]).length);

      const profs = await sb.from('profiles').select('id',{count:'exact',head:true});
      setK('total_profiles', profs.count ?? '–');
    }

    // ---------------- CHARTS ----------------
    let chApps30, chJobsEmp, chJobsType, chAppsLoc;

    async function loadCharts(){
      // Apps last 30 days
      const since = new Date(); since.setDate(since.getDate()-29);
      const a = await sb.from('applications').select('created_at').gte('created_at', since.toISOString());
      const days = [...Array(30)].map((_,i)=>{ const d=new Date(since); d.setDate(since.getDate()+i); return d.toISOString().slice(0,10); });
      const counts = days.map(d => (a.data||[]).filter(x => (x.created_at||'').slice(0,10)===d).length);
      if (chApps30) chApps30.destroy();
      chApps30 = new Chart(el('ch_apps_30'), { type:'line', data:{ labels:days, datasets:[{label:'Applications', data:counts, tension:.35}] },
        options:{ scales:{ x:{ ticks:{maxTicksLimit:6}}}} });

      // Jobs by employment (pie)
      const byEmp = await sb.from('jobs').select('employment');
      const groups = ['full_time','part_time','contract','internship'];
      const empCounts = groups.map(g => (byEmp.data||[]).filter(x => (x.employment||'')===g).length);
      if (chJobsEmp) chJobsEmp.destroy();
      chJobsEmp = new Chart(el('ch_jobs_emp'), { type:'pie', data:{ labels:groups, datasets:[{ data:empCounts }] } });

      // Jobs by type (bar) — same data as above but bar
      if (chJobsType) chJobsType.destroy();
      chJobsType = new Chart(el('ch_jobs_type'), { type:'bar', data:{ labels:groups, datasets:[{ label:'Jobs', data:empCounts }] }, options:{plugins:{legend:{display:false}}} });

      // Applications by location — join app→job and group by job.location
      const aj = await sb.from('applications').select('job_id');
      const ids = [...new Set((aj.data||[]).map(x=>x.job_id))];
      let locs = [];
      if (ids.length){
        const j = await sb.from('jobs').select('id,location').in('id', ids);
        const map = new Map((j.data||[]).map(r=>[r.id,r.location||'Unknown']));
        locs = (aj.data||[]).map(x=> map.get(x.job_id) || 'Unknown');
      }
      const locKeys = [...new Set(locs)];
      const locVals = locKeys.map(k => locs.filter(x=>x===k).length);
      if (chAppsLoc) chAppsLoc.destroy();
      chAppsLoc = new Chart(el('ch_apps_loc'), { type:'bar', data:{ labels:locKeys, datasets:[{ label:'Apps', data:locVals }] }, options:{plugins:{legend:{display:false}}} });

      // Most applied jobs table
      const agg = {};
      (aj.data||[]).forEach(r => agg[r.job_id]=(agg[r.job_id]||0)+1);
      const topIds = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([id])=>id);
      let rows=[];
      if (topIds.length){
        const jj = await sb.from('jobs').select('id,title,companies(name)').in('id', topIds);
        const map = new Map((jj.data||[]).map(r=>[r.id, r]));
        rows = topIds.map(id => ({ id, title: map.get(id)?.title||'(Job)', company: map.get(id)?.companies?.name||'', views: agg[id] }));
      }
      renderTable('tbl_top_jobs', rows, [
        {key:'id',label:'ID'}, {key:'title',label:'Name'}, {key:'company',label:'Company'}, {key:'views',label:'Applications'}
      ]);
    }

    // ---------------- COMPANIES ----------------
    async function loadCompanyOptions(){
      const sel=el('jf_company_id'); if(!sel) return;
      const r=await sb.from('companies').select('id,name').order('name'); sel.innerHTML=(r.data||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }
    async function loadCompaniesTable(){
      const r=await sb.from('companies').select('id,name,website,owner_id,created_at').order('created_at',{ascending:false}).limit(100);
      if(r.error){ renderError('tbl_companies',r.error.message); return; }
      renderTable('tbl_companies', r.data||[], [
        {key:'id',label:'ID'}, {key:'name',label:'Name'}, {key:'website',label:'Website'}, {key:'owner_id',label:'Owner'}, {key:'created_at',label:'Created'},
        {label:'', render:r=>`<button class="btn sm ghost" data-delco="${r.id}">Delete</button>`}
      ]);
      el('tbl_companies').querySelectorAll('[data-delco]').forEach(b=>{
        b.onclick=async()=>{ if(!confirm('Delete this company and its jobs?')) return; const id=b.getAttribute('data-delco'); const d=await sb.from('companies').delete().eq('id',id); if(d.error) alert(d.error.message); await Promise.all([loadCompaniesTable(), loadCounts(), loadJobsTable(), loadCompanyOptions()]); };
      });
    }
    el('companyForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name=el('co_name').value.trim(), site=el('co_site').value.trim()||null, ownerEmail=el('co_owner_email').value.trim(), msg=el('companyMsg');
      msg.textContent='Creating…';
      let owner_id=null;
      if(ownerEmail){
        const r=await sb.from('profiles').select('id').ilike('email', ownerEmail).maybeSingle();
        if(r.error){ alert(r.error.message); msg.textContent=''; return; }
        owner_id=r.data?.id||null;
      }
      const ins=await sb.from('companies').insert([{name,website:site,owner_id}]).select('id').maybeSingle();
      if(ins.error){ alert(ins.error.message); msg.textContent=''; return; }
      msg.textContent='Created ✔'; e.target.reset();
      await Promise.all([loadCompanyOptions(), loadCompaniesTable(), loadCounts()]);
      setTimeout(()=>msg.textContent='',1000);
    });

    // ---------------- JOBS ----------------
    const jobModal=el('jobModal');
    const openModal=()=>jobModal.classList.add('open');
    const closeModal=()=>jobModal.classList.remove('open');
    el('closeJobModal').onclick=closeModal; el('cancelJob').onclick=closeModal;
    el('openCreateJob').onclick=()=>openJobEditor();

    function getJobPayload(){
      const num = (id)=>{ const v=el(id).value; return v===''?null:parseInt(v,10); };
      return {
        company_id: el('jf_company_id').value||null,
        title: el('jf_title').value.trim(),
        location: el('jf_location').value.trim()||null,
        employment: el('jf_employment').value,
        is_remote: el('jf_is_remote').value==='true',
        status: el('jf_status').value,
        salary_min: num('jf_salary_min'),
        salary_max: num('jf_salary_max'),
        currency: el('jf_currency').value.trim()||null,
        featured: el('jf_featured').checked
      };
    }
    async function openJobEditor(row){
      el('jobModalTitle').textContent=row?'Edit Job':'New Job';
      await loadCompanyOptions();
      el('jf_id').value=row?.id||'';
      if(row){
        el('jf_company_id').value=row.company_id||'';
        el('jf_title').value=row.title||'';
        el('jf_location').value=row.location||'';
        el('jf_employment').value=row.employment||'full_time';
        el('jf_is_remote').value = row.is_remote ? 'true':'false';
        el('jf_status').value=row.status||'active';
        el('jf_salary_min').value=row.salary_min??'';
        el('jf_salary_max').value=row.salary_max??'';
        el('jf_currency').value=row.currency||'';
        el('jf_featured').checked=!!row.featured;
      }else{
        el('jobForm').reset(); el('jf_employment').value='full_time'; el('jf_status').value='active'; el('jf_is_remote').value='false'; el('jf_featured').checked=false;
      }
      el('jobFormMsg').textContent='';
      openModal();
    }
    async function saveJob(){
      const id=el('jf_id').value, payload=getJobPayload(); el('jobFormMsg').textContent='Saving…';
      let r; if(id) r=await sb.from('jobs').update(payload).eq('id',id).select('id').maybeSingle();
      else r=await sb.from('jobs').insert([payload]).select('id').maybeSingle();
      if(r.error){ el('jobFormMsg').innerHTML='<span class="error">'+r.error.message+'</span>'; return; }
      el('jobFormMsg').textContent='Saved ✔';
      await Promise.all([loadJobsTable(), loadCounts(), loadCharts()]);
      setTimeout(()=>{ el('jobFormMsg').textContent=''; closeModal(); }, 400);
    }
    el('saveJob').onclick=saveJob;

    el('jobReload').onclick=()=>loadJobsTable();
    ['jobStatus','jobEmployment'].forEach(id=> el(id).onchange=()=>loadJobsTable());
    el('jobSearch').oninput=()=>loadJobsTable();

    async function loadJobsTable(){
      const jobs=await sb.from('jobs').select('id,company_id,title,location,employment,is_remote,status,featured,salary_min,salary_max,currency,created_at,companies(name)').order('created_at',{ascending:false}).limit(200);
      if(jobs.error){ renderError('tbl_jobs', jobs.error.message); return; }
      const filterS = el('jobStatus').value, filterE = el('jobEmployment').value, term = el('jobSearch').value.trim().toLowerCase();
      let list = jobs.data||[];
      if(filterS) list = list.filter(r=> (r.status||'')===filterS);
      if(filterE) list = list.filter(r=> (r.employment||'')===filterE);
      if(term) list = list.filter(r => (r.title||'').toLowerCase().includes(term) || (r.location||'').toLowerCase().includes(term) || (r.companies?.name||'').toLowerCase().includes(term));

      renderTable('tbl_jobs', list, [
        {key:'id',label:'ID'},
        {label:'Title', render:r=> `<div><strong>${r.title||''}</strong><div class="muted" style="font-size:12px">${r.companies?.name||''}</div></div>`},
        {label:'Meta', render:r=> `<span class="pill">${(r.employment||'').replace('_',' ')}</span> ${r.is_remote?'<span class="pill">Remote</span>':''} ${r.featured?'<span class="pill">★ Featured</span>':''}`},
        {key:'location',label:'Location'},
        {label:'Salary', render:r=> [r.currency||'', r.salary_min??'', r.salary_max?('-'+r.salary_max):''].join(' ').trim()},
        {key:'status',label:'Status'},
        {key:'created_at',label:'Created'},
        {label:'Actions', render:r=>`
          <div class="row">
            <button class="btn sm ghost" data-edit="${r.id}">Edit</button>
            <button class="btn sm ghost" data-feat="${r.id}">${r.featured?'Unfeature':'Feature'}</button>
            <button class="btn sm ghost" data-stat="${r.id}">${r.status==='active'?'Close':'Open'}</button>
            <button class="btn sm" data-del="${r.id}">Delete</button>
          </div>`}
      ]);

      const host=el('tbl_jobs');
      host.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> openJobEditor(list.find(x=>x.id===b.getAttribute('data-edit'))));
      host.querySelectorAll('[data-feat]').forEach(b=> b.onclick=async ()=>{ const id=b.getAttribute('data-feat'); const row=list.find(x=>x.id===id); const u=await sb.from('jobs').update({featured:!row.featured}).eq('id',id); if(u.error) alert(u.error.message); await Promise.all([loadJobsTable(), loadCounts(), loadCharts()]); });
      host.querySelectorAll('[data-stat]').forEach(b=> b.onclick=async ()=>{ const id=b.getAttribute('data-stat'); const row=list.find(x=>x.id===id); const next=row.status==='active'?'closed':'active'; const u=await sb.from('jobs').update({status:next}).eq('id',id); if(u.error) alert(u.error.message); await Promise.all([loadJobsTable(), loadCounts(), loadCharts()]); });
      host.querySelectorAll('[data-del]').forEach(b=> b.onclick=async ()=>{ if(!confirm('Delete this job?')) return; const id=b.getAttribute('data-del'); const d=await sb.from('jobs').delete().eq('id',id); if(d.error) alert(d.error.message); await Promise.all([loadJobsTable(), loadCounts(), loadCharts()]); });
    }

    // ---------------- APPLICATIONS ----------------
    async function loadApplications(){
      const a=await sb.from('applications').select('id,job_id,applicant_id,status,created_at').order('created_at',{ascending:false}).limit(200);
      if(a.error){ renderError('tbl_apps', a.error.message); return; }
      const jobIds=[...new Set((a.data||[]).map(x=>x.job_id))];
      const userIds=[...new Set((a.data||[]).map(x=>x.applicant_id))];
      const [j,p]=await Promise.all([
        jobIds.length? sb.from('jobs').select('id,title,companies(name)').in('id',jobIds):{data:[]},
        userIds.length? sb.from('profiles').select('id,full_name,email').in('id',userIds):{data:[]}
      ]);
      const jobMap=new Map((j.data||[]).map(r=>[r.id,r]));
      const userMap=new Map((p.data||[]).map(r=>[r.id,r]));
      const opts=['pending','reviewed','shortlisted','hired','rejected'];

      renderTable('tbl_apps', a.data||[], [
        {label:'Job', render:r=>`${jobMap.get(r.job_id)?.title||'(Job)'} — ${jobMap.get(r.job_id)?.companies?.name||''}`},
        {label:'Applicant', render:r=>{ const u=userMap.get(r.applicant_id)||{}; return `${u.full_name||''} ${u.email?('('+u.email+')'):''}`; }},
        {label:'Status', render:r=>`<select data-app="${r.id}">${opts.map(o=>`<option value="${o}" ${o===r.status?'selected':''}>${o}</option>`).join('')}</select>`},
        {key:'created_at',label:'Applied'},
        {label:'', render:r=>`<button class="btn sm ghost" data-delapp="${r.id}">Delete</button>`}
      ]);

      const host=el('tbl_apps');
      host.querySelectorAll('select[data-app]').forEach(sel=> sel.onchange=async()=>{ const id=sel.getAttribute('data-app'); const v=sel.value; const r=await sb.from('applications').update({status:v}).eq('id',id); if(r.error) alert(r.error.message); else loadCounts(); });
      host.querySelectorAll('[data-delapp]').forEach(b=> b.onclick=async()=>{ if(!confirm('Delete this application?')) return; const id=b.getAttribute('data-delapp'); const r=await sb.from('applications').delete().eq('id',id); if(r.error) alert(r.error.message); await Promise.all([loadApplications(), loadCounts(), loadCharts()]); });
    }

    // ---------------- PROFILES ----------------
    async function loadProfiles(){
      const r=await sb.from('profiles').select('id,full_name,email,role,created_at').order('created_at',{ascending:false}).limit(200);
      if(r.error){ renderError('tbl_profiles', r.error.message); return; }
      const roleOpts=['user','admin','super_admin'];
      renderTable('tbl_profiles', r.data||[], [
        {key:'id',label:'ID'},{key:'full_name',label:'Name'},{key:'email',label:'Email'},
        {label:'Role', render:x=>`<select data-prof="${x.id}">${roleOpts.map(o=>`<option value="${o}" ${String(x.role||'').toLowerCase()===o?'selected':''}>${o}</option>`).join('')}</select>`},
        {key:'created_at',label:'Created'}
      ]);
      el('tbl_profiles').querySelectorAll('select[data-prof]').forEach(sel=> sel.onchange=async()=>{ const id=sel.getAttribute('data-prof'); const v=sel.value; const u=await sb.from('profiles').update({role:v}).eq('id',id); if(u.error) alert(u.error.message); else alert('Updated ✔'); });
    }

    // Boot
    await Promise.all([loadCounts(), loadCharts(), loadCompaniesTable(), loadJobsTable(), loadApplications(), loadProfiles()]);
  });
  </script>
</body>
</html>
