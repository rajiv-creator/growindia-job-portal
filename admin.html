<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia ‚Äî Admin</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Supabase v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Your project keys & client: must set window.supabase = createClient(...) -->
  <script src="config.js?v=12"></script>

  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb; --text2:#9ca3af; --brand:#22c55e; --brand2:#3b82f6; --accent:#f59e0b; --danger:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    a{color:inherit;text-decoration:none}
    .wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .side{background:#0b1222;border-right:1px solid #111320;padding:16px 12px;position:sticky;top:0;height:100vh}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;margin-bottom:18px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:var(--text2)}
    .nav a.active, .nav a:hover{background:var(--muted);color:var(--text)}
    .top{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #111320;background:#0b1222;position:sticky;top:0;z-index:5}
    .search{display:flex;gap:10px;align-items:center;background:var(--muted);padding:8px 12px;border-radius:10px;min-width:280px}
    .search input{all:unset;color:var(--text);width:260px}
    .user{display:flex;gap:10px;align-items:center}
    .main{padding:18px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){ .grid-4{grid-template-columns:repeat(4,1fr)} .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid #111320;border-radius:14px;padding:16px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .big{font-size:26px;font-weight:700}
    .muted{color:var(--text2)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--brand2);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.alt{background:var(--muted);color:var(--text)}
    .btn.warn{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #111320;text-align:left}
    th{color:var(--text2);font-weight:600}
    .pill{padding:5px 10px;border-radius:999px;font-size:12px}
    .ok{background:rgba(34,197,94,.15);color:#86efac}
    .draft{background:rgba(245,158,11,.15);color:#fcd34d}
    .closed{background:rgba(239,68,68,.15);color:#fca5a5}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toolbar input, .toolbar select{background:#0b1222;border:1px solid #111320;color:var(--text);padding:8px 10px;border-radius:10px}
    .pagination{display:flex;gap:8px;align-items:center}
    .empty{padding:24px;text-align:center;color:var(--text2)}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1222;border:1px solid #111320;color:var(--text);padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal.show{display:flex}
    .panel{background:#0b1222;border:1px solid #111320;border-radius:16px;max-width:800px;width:100%}
    .panel .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #111320}
    .panel .body{padding:16px}
    .form{display:grid;gap:12px}
    @media(min-width:760px){ .form{grid-template-columns:1fr 1fr} .form .full{grid-column:1/-1} }
    label{display:block;font-size:12px;color:var(--text2);margin-bottom:6px}
    input[type=text], input[type=number], input[type=email], input[type=url], textarea, select{width:100%;background:#0b1222;border:1px solid #1f2537;color:var(--text);padding:10px;border-radius:10px}
    textarea{min-height:100px;resize:vertical}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="side">
      <div class="brand"><span class="dot"></span> GrowIndia Admin</div>
      <nav class="nav" id="nav">
        <a class="active" href="#dashboard" data-target="dashboardSection">üìä Dashboard</a>
        <a href="#jobs" data-target="jobsSection">üíº Jobs</a>
        <a href="#employers" data-target="employersSection">üè¢ Employers</a>
        <a href="#applications" data-target="applicationsSection">üìù Applications</a>
        <a href="#logout" id="logoutBtn">üö™ Logout</a>
      </nav>
    </aside>

    <div>
      <div class="top">
        <div class="search"><span>üîé</span><input id="topSearch" placeholder="Search jobs, employers, candidates..." /></div>
        <div class="user"><span id="whoami" class="muted">‚Äî</span></div>
      </div>

      <main class="main">
        <!-- DASHBOARD -->
        <section id="dashboardSection">
          <section class="grid grid-4">
            <div class="card kpi"><span class="muted">Total Jobs</span><span id="kpiJobs" class="big">0</span></div>
            <div class="card kpi"><span class="muted">Active Jobs</span><span id="kpiJobsActive" class="big">0</span></div>
            <div class="card kpi"><span class="muted">Employers</span><span id="kpiEmployers" class="big">0</span></div>
            <div class="card kpi"><span class="muted">Applications</span><span id="kpiApps" class="big">0</span></div>
          </section>

          <section class="grid grid-2" style="margin-top:14px">
            <div class="card"><div class="row" style="justify-content:space-between"><h3>Applications (last 14 days)</h3></div><canvas id="appsLine"></canvas></div>
            <div class="card"><div class="row" style="justify-content:space-between"><h3>Jobs by Status</h3></div><canvas id="jobsPie"></canvas></div>
          </section>
        </section>

        <!-- JOBS CRUD -->
        <section id="jobsSection" style="margin-top:14px;display:none">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h3>Jobs</h3>
              <div class="toolbar">
                <input id="jobSearch" placeholder="Search title/company‚Ä¶" />
                <select id="jobStatus">
                  <option value="">All statuses</option>
                  <option value="active">Active</option>
                  <option value="draft">Draft</option>
                  <option value="closed">Closed</option>
                </select>
                <select id="jobType">
                  <option value="">All types</option>
                  <option>Full-time</option>
                  <option>Part-time</option>
                  <option>Contract</option>
                  <option>Internship</option>
                  <option>Remote</option>
                </select>
                <button class="btn" id="addJobBtn">Ôºã Add Job</button>
              </div>
            </div>
            <div style="overflow:auto;margin-top:10px">
              <table id="jobsTable">
                <thead>
                  <tr>
                    <th>Title</th><th>Company</th><th>Location</th><th>Type</th><th>Salary</th><th>Status</th><th style="width:160px">Actions</th>
                  </tr>
                </thead>
                <tbody id="jobsTbody">
                  <tr><td colspan="7" class="empty">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="justify-content:space-between;margin-top:10px">
              <div class="muted" id="jobsCount">‚Äî</div>
              <div class="pagination">
                <button class="btn alt" id="prevPage">Prev</button>
                <span id="pageInfo" class="muted">1 / 1</span>
                <button class="btn alt" id="nextPage">Next</button>
              </div>
            </div>
          </div>
        </section>

        <!-- EMPLOYERS CRUD -->
        <section id="employersSection" style="margin-top:14px;display:none">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h3>Employers</h3>
              <div class="toolbar">
                <input id="empSearch" placeholder="Search name/email‚Ä¶" />
                <select id="empVerified">
                  <option value="">All</option>
                  <option value="true">Verified</option>
                  <option value="false">Unverified</option>
                </select>
                <button class="btn" id="addEmpBtn">Ôºã Add Employer</button>
              </div>
            </div>
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th>Name</th><th>Email</th><th>Website</th><th>Phone</th><th>Verified</th><th style="width:160px">Actions</th>
                  </tr>
                </thead>
                <tbody id="empTbody">
                  <tr><td colspan="6" class="empty">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="justify-content:space-between;margin-top:10px">
              <div class="muted" id="empCount">‚Äî</div>
              <div class="pagination">
                <button class="btn alt" id="empPrev">Prev</button>
                <span id="empPageInfo" class="muted">1 / 1</span>
                <button class="btn alt" id="empNext">Next</button>
              </div>
            </div>
          </div>
        </section>

        <!-- APPLICATIONS CRUD -->
        <section id="applicationsSection" style="margin-top:14px;display:none">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h3>Applications</h3>
              <div class="toolbar">
                <input id="appSearch" placeholder="Search name/email‚Ä¶" />
                <select id="appStatus">
                  <option value="">All statuses</option>
                  <option>submitted</option>
                  <option>reviewed</option>
                  <option>shortlisted</option>
                  <option>rejected</option>
                  <option>hired</option>
                </select>
                <select id="appJob"></select>
                <button class="btn" id="addAppBtn">Ôºã Add Application</button>
              </div>
            </div>
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th>Candidate</th><th>Email</th><th>Job</th><th>Status</th><th>Resume</th><th style="width:160px">Actions</th>
                  </tr>
                </thead>
                <tbody id="appsTbody">
                  <tr><td colspan="6" class="empty">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="justify-content:space-between;margin-top:10px">
              <div class="muted" id="appsCount">‚Äî</div>
              <div class="pagination">
                <button class="btn alt" id="appsPrev">Prev</button>
                <span id="appsPageInfo" class="muted">1 / 1</span>
                <button class="btn alt" id="appsNext">Next</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Add/Edit Job Modal -->
  <div class="modal" id="jobModal">
    <div class="panel">
      <div class="head"><b id="modalTitle">Add Job</b><button class="btn alt" id="closeModal">‚úï</button></div>
      <div class="body">
        <form id="jobForm" class="form">
          <input type="hidden" id="job_id"/>
          <div>
            <label>Title</label>
            <input type="text" id="title" required/>
          </div>
          <div>
            <label>Company</label>
            <input type="text" id="company" required/>
          </div>
          <div>
            <label>Location</label>
            <input type="text" id="location" placeholder="City, State"/>
          </div>
          <div>
            <label>Type</label>
            <select id="type">
              <option>Full-time</option><option>Part-time</option><option>Contract</option><option>Internship</option><option>Remote</option>
            </select>
          </div>
          <div>
            <label>Salary Min</label>
            <input type="number" id="salary_min" min="0" step="1000"/>
          </div>
          <div>
            <label>Salary Max</label>
            <input type="number" id="salary_max" min="0" step="1000"/>
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option value="active">Active</option><option value="draft">Draft</option><option value="closed">Closed</option>
            </select>
          </div>
          <div class="full">
            <label>Description</label>
            <textarea id="description" placeholder="Role description, requirements, etc."></textarea>
          </div>
          <div class="full row" style="justify-content:flex-end;margin-top:8px">
            <button type="button" class="btn alt" id="cancelJob">Cancel</button>
            <button type="submit" class="btn" id="saveJob">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add/Edit Employer Modal -->
  <div class="modal" id="empModal">
    <div class="panel">
      <div class="head"><b id="empModalTitle">Add Employer</b><button class="btn alt" id="closeEmpModal">‚úï</button></div>
      <div class="body">
        <form id="empForm" class="form">
          <input type="hidden" id="emp_id"/>
          <div>
            <label>Name</label>
            <input id="emp_name" type="text" required/>
          </div>
          <div>
            <label>Email</label>
            <input id="emp_email" type="email" required/>
          </div>
          <div>
            <label>Website</label>
            <input id="emp_website" type="url" placeholder="https://‚Ä¶"/>
          </div>
          <div>
            <label>Phone</label>
            <input id="emp_phone" type="text"/>
          </div>
          <div class="full">
            <label><input type="checkbox" id="emp_verified"/> Verified</label>
          </div>
          <div class="full">
            <label>Notes</label>
            <textarea id="emp_notes" placeholder="Internal notes (not public)"></textarea>
          </div>
          <div class="full row" style="justify-content:flex-end;margin-top:8px">
            <button type="button" class="btn alt" id="cancelEmp">Cancel</button>
            <button type="submit" class="btn" id="saveEmp">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add/Edit Application Modal -->
  <div class="modal" id="appModal">
    <div class="panel">
      <div class="head"><b id="appModalTitle">Add Application</b><button class="btn alt" id="closeAppModal">‚úï</button></div>
      <div class="body">
        <form id="appForm" class="form">
          <input type="hidden" id="app_id"/>
          <div>
            <label>Job</label>
            <select id="app_job_id" required></select>
          </div>
          <div>
            <label>Candidate name</label>
            <input id="app_name" required/>
          </div>
          <div>
            <label>Email</label>
            <input id="app_email" type="email" required/>
          </div>
          <div class="full">
            <label>Resume URL</label>
            <input id="app_resume" type="url" placeholder="https://‚Ä¶"/>
          </div>
          <div>
            <label>Status</label>
            <select id="app_status">
              <option>submitted</option>
              <option>reviewed</option>
              <option>shortlisted</option>
              <option>rejected</option>
              <option>hired</option>
            </select>
          </div>
          <div class="full row" style="justify-content:flex-end;margin-top:8px">
            <button type="button" class="btn alt" id="cancelApp">Cancel</button>
            <button type="submit" class="btn" id="saveApp">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---- Helpers ----
    const db = window.supabase; // from config.js
    const show = (el, flag=true)=> el.classList[flag?'add':'remove']('show');
    const toast = (msg, ok=true)=>{ const t=document.getElementById('toast'); t.textContent = msg; t.style.borderColor = ok ? 'var(--brand)' : 'var(--danger)'; show(t,true); setTimeout(()=>show(t,false),2200); };
    const fmtINR = (n)=> n? new Intl.NumberFormat('en-IN').format(n):'-';
    function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function v(id){ return document.getElementById(id).value.trim(); }
    function n(id){ const x = document.getElementById(id).value; return x===''? null : Number(x); }

    // ---- Auth ----
    async function guard() {
      const { data: { session } } = await db.auth.getSession();
      if (!session) { location.href = 'post.auth.html'; return; }
      document.getElementById('whoami').textContent = session.user.email;
    }
    document.getElementById('logoutBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await db.auth.signOut(); location.href='post.auth.html'; });

    // ---- Router (show sections) ----
    const sections = ['dashboardSection','jobsSection','employersSection','applicationsSection'];
    function showSection(id){
      sections.forEach(s=>{ const el=document.getElementById(s); if(!el) return; el.style.display = (s===id)?'block':'none'; });
      document.querySelectorAll('#nav a').forEach(a=> a.classList.toggle('active', a.dataset.target===id));
    }
    window.addEventListener('hashchange', ()=>{
      const key = (location.hash||'#dashboard').replace('#','');
      const map = { dashboard:'dashboardSection', jobs:'jobsSection', employers:'employersSection', applications:'applicationsSection' };
      showSection(map[key]||'dashboardSection');
    });

    // ---- KPIs & Charts ----
    let appsLineChart, jobsPieChart;
    async function loadKPIsAndCharts(){
      const [{ data: jobs, error: e1 }, { data: emps, error: e2 }, { data: apps, error: e3 }] = await Promise.all([
        db.from('jobs').select('id,status,created_at'),
        db.from('employers').select('id'),
        db.from('applications').select('id,created_at')
      ]);
      if (e1||e2||e3){ console.error(e1||e2||e3); return; }
      document.getElementById('kpiJobs').textContent = jobs.length;
      document.getElementById('kpiJobsActive').textContent = jobs.filter(j=>j.status==='active').length;
      document.getElementById('kpiEmployers').textContent = emps.length;
      document.getElementById('kpiApps').textContent = apps.length;
      const days = [...Array(14)].map((_,i)=>{ const d=new Date(); d.setDate(d.getDate()-(13-i)); return d.toISOString().slice(0,10); });
      const countByDay = days.map(d => apps.filter(a => (a.created_at||'').slice(0,10)===d).length);
      const ctx1 = document.getElementById('appsLine'); appsLineChart?.destroy();
      appsLineChart = new Chart(ctx1, { type:'line', data:{ labels:days, datasets:[{ label:'Applications', data:countByDay, tension:.35, fill:false }]}, options:{ plugins:{ legend:{ display:false }}, scales:{ x:{ ticks:{ color:'#9ca3af'}}, y:{ ticks:{ color:'#9ca3af'}}}} });
      const sCount = { active:0, draft:0, closed:0 }; jobs.forEach(j => sCount[j.status] = (sCount[j.status]||0)+1);
      const ctx2 = document.getElementById('jobsPie'); jobsPieChart?.destroy();
      jobsPieChart = new Chart(ctx2, { type:'doughnut', data:{ labels:['Active','Draft','Closed'], datasets:[{ data:[sCount.active||0, sCount.draft||0, sCount.closed||0] }]}, options:{ plugins:{ legend:{ labels:{ color:'#9ca3af' }}}}});
    }

    // ---- JOBS CRUD ----
    const PAGE_SIZE = 10; let page = 1, totalRows = 0;
    function stateJobFilters(){ return { q: v('jobSearch'), status: document.getElementById('jobStatus').value, type: document.getElementById('jobType').value }; }
    async function countJobs(filters){ let q = db.from('jobs').select('id', { count: 'exact', head: true }); if (filters.q){ q = q.or(`title.ilike.%${filters.q}%,company.ilike.%${filters.q}%`); } if (filters.status) q = q.eq('status', filters.status); if (filters.type) q = q.eq('type', filters.type); const { count, error } = await q; if (error){ console.error(error); return 0; } return count || 0; }
    async function loadJobs(p=1){ const f = stateJobFilters(); totalRows = await countJobs(f); const totalPages = Math.max(1, Math.ceil(totalRows / PAGE_SIZE)); page = Math.min(Math.max(1, p), totalPages); const from = (page-1)*PAGE_SIZE; const to = from + PAGE_SIZE - 1; let q = db.from('jobs').select('*').order('created_at',{ascending:false}).range(from, to); if (f.q){ q = q.or(`title.ilike.%${f.q}%,company.ilike.%${f.q}%`); } if (f.status) q = q.eq('status', f.status); if (f.type) q = q.eq('type', f.type); const { data, error } = await q; const tbody = document.getElementById('jobsTbody'); if (error){ console.error(error); tbody.innerHTML = `<tr><td colspan="7" class="empty">Failed to load jobs.</td></tr>`; return; } if (!data || !data.length){ tbody.innerHTML = `<tr><td colspan="7" class="empty">No jobs found.</td></tr>`; } else { tbody.innerHTML = data.map(j => { const sal = (j.salary_min||j.salary_max) ? `‚Çπ ${fmtINR(j.salary_min)||''}${j.salary_max ? ' - ‚Çπ '+fmtINR(j.salary_max):''}` : '-'; const statusClass = j.status==='active'?'ok':(j.status==='draft'?'draft':'closed'); return `<tr>
            <td>${escapeHTML(j.title||'-')}</td>
            <td>${escapeHTML(j.company||'-')}</td>
            <td>${escapeHTML(j.location||'-')}</td>
            <td>${escapeHTML(j.type||'-')}</td>
            <td>${sal}</td>
            <td><span class="pill ${statusClass}">${j.status||'-'}</span></td>
            <td>
              <button class="btn alt" data-edit="${j.id}">Edit</button>
              <button class="btn warn" data-del="${j.id}">Delete</button>
            </td>
          </tr>`; }).join(''); } document.getElementById('jobsCount').textContent = `${totalRows} result${totalRows===1?'':'s'}`; document.getElementById('pageInfo').textContent = `${page} / ${Math.max(1, Math.ceil(totalRows/PAGE_SIZE))}`; tbody.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>openJobModal(b.dataset.edit)); tbody.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>deleteJob(b.dataset.del)); }
    document.getElementById('prevPage').onclick = ()=> loadJobs(page-1); document.getElementById('nextPage').onclick = ()=> loadJobs(page+1);
    ['jobSearch','jobStatus','jobType'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input', ()=> loadJobs(1)); el.addEventListener('change', ()=> loadJobs(1)); });
    document.getElementById('topSearch').addEventListener('input', (e)=>{ const val=e.target.value; const active = document.querySelector('#nav a.active')?.dataset.target; if(active==='jobsSection'){ document.getElementById('jobSearch').value = val; loadJobs(1); } if(active==='employersSection'){ document.getElementById('empSearch').value = val; loadEmployers(1); } if(active==='applicationsSection'){ document.getElementById('appSearch').value = val; loadApplications(1); } });

    const jobModal = document.getElementById('jobModal'); const modalTitle = document.getElementById('modalTitle'); const jobForm = document.getElementById('jobForm');
    document.getElementById('addJobBtn').onclick = ()=> openJobModal(null);
    document.getElementById('closeModal').onclick = ()=> show(jobModal,false);
    document.getElementById('cancelJob').onclick = ()=> show(jobModal,false);
    async function openJobModal(id){ jobForm.reset(); document.getElementById('job_id').value = id||''; modalTitle.textContent = id ? 'Edit Job' : 'Add Job'; if (id){ const { data, error } = await db.from('jobs').select('*').eq('id', id).single(); if (error){ toast('Failed to load job', false); return; } for (const k of ['title','company','location','type','salary_min','salary_max','status','description']){ const el = document.getElementById(k); if (el) el.value = data[k] ?? ''; } } show(jobModal,true); }
    jobForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const btn = document.getElementById('saveJob'); btn.disabled = true; const payload = { title: v('title'), company: v('company'), location: v('location'), type: v('type'), salary_min: n('salary_min'), salary_max: n('salary_max'), status: v('status'), description: v('description') }; const id = v('job_id'); let res; if (id){ res = await db.from('jobs').update(payload).eq('id', id).select('id').single(); } else { res = await db.from('jobs').insert(payload).select('id').single(); } btn.disabled = false; if (res.error){ console.error(res.error); toast('Save failed', false); return; } show(jobModal,false); toast(id ? 'Job updated' : 'Job added'); await Promise.all([loadJobs(page), loadKPIsAndCharts()]); });
    async function deleteJob(id){ if (!confirm('Delete this job?')) return; const { error } = await db.from('jobs').delete().eq('id', id); if (error){ toast('Delete failed', false); return; } toast('Job deleted'); await Promise.all([loadJobs(page), loadKPIsAndCharts()]); }

    // ---- EMPLOYERS CRUD ----
    const EMP_PAGE = 10; let empPage=1, empTotal=0;
    function empFilters(){ return { q: v('empSearch'), verified: document.getElementById('empVerified').value }; }
    async function countEmployers(f){ let q = db.from('employers').select('id',{count:'exact', head:true}); if (f.q){ q = q.or(`name.ilike.%${f.q}%,email.ilike.%${f.q}%`); } if (f.verified){ q = q.eq('verified', f.verified==='true'); } const { count, error } = await q; if (error){ console.error(error); return 0; } return count||0; }
    async function loadEmployers(p=1){ const f = empFilters(); empTotal = await countEmployers(f); const pages = Math.max(1, Math.ceil(empTotal/EMP_PAGE)); empPage = Math.min(Math.max(1,p), pages); const from=(empPage-1)*EMP_PAGE, to=from+EMP_PAGE-1; let q = db.from('employers').select('*').order('created_at',{ascending:false}).range(from,to); if (f.q){ q = q.or(`name.ilike.%${f.q}%,email.ilike.%${f.q}%`); } if (f.verified){ q = q.eq('verified', f.verified==='true'); }
      const { data, error } = await q; const tbody = document.getElementById('empTbody'); if (error){ console.error(error); tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load employers.</td></tr>`; return; }
      if (!data || !data.length){ tbody.innerHTML = `<tr><td colspan="6" class="empty">No employers found.</td></tr>`; }
      else { tbody.innerHTML = data.map(e=>`<tr>
          <td>${escapeHTML(e.name||'-')}</td>
          <td>${escapeHTML(e.email||'-')}</td>
          <td>${e.website?`<a href="${escapeHTML(e.website)}" target="_blank">${escapeHTML((e.website||'').replace(/^https?:\/\//,''))}</a>`:'‚Äî'}</td>
          <td>${escapeHTML(e.phone||'‚Äî')}</td>
          <td>${e.verified?'<span class="pill ok">Yes</span>':'<span class="pill draft">No</span>'}</td>
          <td>
            <button class="btn alt" data-emp-edit="${e.id}">Edit</button>
            <button class="btn warn" data-emp-del="${e.id}">Delete</button>
          </td>
        </tr>`).join('');
      }
      document.getElementById('empCount').textContent = `${empTotal} employer${empTotal===1?'':'s'}`;
      document.getElementById('empPageInfo').textContent = `${empPage} / ${pages}`;
      tbody.querySelectorAll('button[data-emp-edit]').forEach(b=> b.onclick = ()=> openEmpModal(b.dataset.empEdit));
      tbody.querySelectorAll('button[data-emp-del]').forEach(b=> b.onclick = ()=> deleteEmployer(b.dataset.empDel));
    }
    document.getElementById('empPrev').onclick = ()=> loadEmployers(empPage-1);
    document.getElementById('empNext').onclick = ()=> loadEmployers(empPage+1);
    ['empSearch','empVerified'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input', ()=> loadEmployers(1)); el.addEventListener('change', ()=> loadEmployers(1)); });

    const empModal = document.getElementById('empModal'); const empForm=document.getElementById('empForm');
    document.getElementById('addEmpBtn').onclick = ()=> openEmpModal(null);
    document.getElementById('closeEmpModal').onclick = ()=> show(empModal,false);
    document.getElementById('cancelEmp').onclick = ()=> show(empModal,false);
    async function openEmpModal(id){ empForm.reset(); document.getElementById('emp_id').value = id||''; document.getElementById('empModalTitle').textContent = id? 'Edit Employer' : 'Add Employer'; if (id){ const { data, error } = await db.from('employers').select('*').eq('id', id).single(); if (error){ toast('Failed to load employer', false); return; } document.getElementById('emp_name').value = data.name||''; document.getElementById('emp_email').value = data.email||''; document.getElementById('emp_website').value = data.website||''; document.getElementById('emp_phone').value = data.phone||''; document.getElementById('emp_verified').checked = !!data.verified; document.getElementById('emp_notes').value = data.notes||''; }
      show(empModal,true);
    }
    empForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const btn = document.getElementById('saveEmp'); btn.disabled=true; const payload={ name:v('emp_name'), email:v('emp_email'), website:v('emp_website')||null, phone:v('emp_phone')||null, verified: document.getElementById('emp_verified').checked, notes: v('emp_notes')||null }; const id=v('emp_id'); let res; if(id){ res = await db.from('employers').update(payload).eq('id', id).select('id').single(); } else { res = await db.from('employers').insert(payload).select('id').single(); } btn.disabled=false; if(res.error){ console.error(res.error); toast('Save failed', false); return; } show(empModal,false); toast(id? 'Employer updated' : 'Employer added'); await Promise.all([loadEmployers(empPage), loadKPIsAndCharts()]); });
    async function deleteEmployer(id){ if(!confirm('Delete this employer?')) return; const { error } = await db.from('employers').delete().eq('id', id); if(error){ toast('Delete failed', false); return; } toast('Employer deleted'); await Promise.all([loadEmployers(empPage), loadKPIsAndCharts()]); }

    // ---- APPLICATIONS CRUD ----
    const APPS_PAGE=10; let appsPage=1, appsTotal=0; let jobsCache=[]; async function refreshJobsCache(){ const { data, error } = await db.from('jobs').select('id,title,company').order('created_at',{ascending:false}); if(!error) jobsCache = data||[]; const jobFilter = document.getElementById('appJob'); jobFilter.innerHTML = `<option value="">All jobs</option>` + (jobsCache.map(j=>`<option value="${j.id}">${escapeHTML(j.title)} ‚Äî ${escapeHTML(j.company||'')}</option>`).join('')); const jobSelect = document.getElementById('app_job_id'); jobSelect.innerHTML = jobsCache.map(j=>`<option value="${j.id}">${escapeHTML(j.title)} ‚Äî ${escapeHTML(j.company||'')}</option>`).join(''); }
    function appFilters(){ return { q: v('appSearch'), status: document.getElementById('appStatus').value, job: document.getElementById('appJob').value }; }
    async function countApps(f){ let q = db.from('applications').select('id',{count:'exact', head:true}); if(f.q){ q = q.or(`candidate_name.ilike.%${f.q}%,candidate_email.ilike.%${f.q}%`); } if(f.status) q = q.eq('status', f.status); if(f.job) q = q.eq('job_id', f.job); const { count, error } = await q; if (error){ console.error(error); return 0; } return count||0; }
    async function loadApplications(p=1){ const f = appFilters(); appsTotal = await countApps(f); const pages=Math.max(1, Math.ceil(appsTotal/APPS_PAGE)); appsPage = Math.min(Math.max(1,p), pages); const from=(appsPage-1)*APPS_PAGE, to=from+APPS_PAGE-1; let q = db.from('applications').select('*').order('created_at',{ascending:false}).range(from,to); if(f.q){ q = q.or(`candidate_name.ilike.%${f.q}%,candidate_email.ilike.%${f.q}%`); } if(f.status) q = q.eq('status', f.status); if(f.job) q = q.eq('job_id', f.job); const { data, error } = await q; const tbody = document.getElementById('appsTbody'); if(error){ console.error(error); tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load applications.</td></tr>`; return; } if(!data || !data.length){ tbody.innerHTML = `<tr><td colspan="6" class="empty">No applications found.</td></tr>`; } else { const jobMap = Object.fromEntries(jobsCache.map(j=>[j.id, `${j.title} ‚Äî ${j.company||''}`])); tbody.innerHTML = data.map(a=>`<tr>
          <td>${escapeHTML(a.candidate_name||'-')}</td>
          <td>${escapeHTML(a.candidate_email||'-')}</td>
          <td>${escapeHTML(jobMap[a.job_id]||a.job_id)}</td>
          <td><span class="pill ${statusPill(a.status)}">${escapeHTML(a.status||'-')}</span></td>
          <td>${a.resume_url?`<a target="_blank" href="${escapeHTML(a.resume_url)}">Open</a>`:'‚Äî'}</td>
          <td>
            <button class="btn alt" data-app-edit="${a.id}">Edit</button>
            <button class="btn warn" data-app-del="${a.id}">Delete</button>
          </td>
        </tr>`).join(''); }
      document.getElementById('appsCount').textContent = `${appsTotal} application${appsTotal===1?'':'s'}`; document.getElementById('appsPageInfo').textContent = `${appsPage} / ${pages}`; tbody.querySelectorAll('button[data-app-edit]').forEach(b=> b.onclick = ()=> openAppModal(b.dataset.appEdit)); tbody.querySelectorAll('button[data-app-del]').forEach(b=> b.onclick = ()=> deleteApplication(b.dataset.appDel)); }
    function statusPill(s){ return s==='hired'?'ok':(s==='rejected'?'closed':'draft'); }
    document.getElementById('appsPrev').onclick = ()=> loadApplications(appsPage-1);
    document.getElementById('appsNext').onclick = ()=> loadApplications(appsPage+1);
    ['appSearch','appStatus','appJob'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input', ()=> loadApplications(1)); el.addEventListener('change', ()=> loadApplications(1)); });

    const appModal=document.getElementById('appModal'); const appForm=document.getElementById('appForm');
    document.getElementById('addAppBtn').onclick = ()=> openAppModal(null);
    document.getElementById('closeAppModal').onclick = ()=> show(appModal,false);
    document.getElementById('cancelApp').onclick = ()=> show(appModal,false);
    async function openAppModal(id){ appForm.reset(); document.getElementById('app_id').value = id||''; document.getElementById('appModalTitle').textContent = id? 'Edit Application' : 'Add Application'; if(id){ const { data, error } = await db.from('applications').select('*').eq('id', id).single(); if(error){ toast('Failed to load application', false); return; } document.getElementById('app_job_id').value = data.job_id; document.getElementById('app_name').value = data.candidate_name||''; document.getElementById('app_email').value = data.candidate_email||''; document.getElementById('app_resume').value = data.resume_url||''; document.getElementById('app_status').value = data.status||'submitted'; }
      show(appModal,true);
    }
    appForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const btn=document.getElementById('saveApp'); btn.disabled=true; const payload={ job_id: document.getElementById('app_job_id').value, candidate_name: v('app_name'), candidate_email: v('app_email'), resume_url: v('app_resume')||null, status: document.getElementById('app_status').value }; const id=v('app_id'); let res; if(id){ res = await db.from('applications').update(payload).eq('id', id).select('id').single(); } else { res = await db.from('applications').insert(payload).select('id').single(); } btn.disabled=false; if(res.error){ console.error(res.error); toast('Save failed', false); return; } show(appModal,false); toast(id? 'Application updated' : 'Application added'); await Promise.all([loadApplications(appsPage), loadKPIsAndCharts()]); });
    async function deleteApplication(id){ if(!confirm('Delete this application?')) return; const { error } = await db.from('applications').delete().eq('id', id); if(error){ toast('Delete failed', false); return; } toast('Application deleted'); await Promise.all([loadApplications(appsPage), loadKPIsAndCharts()]); }

    // ---- Init ----
    (async function init(){
      await guard();
      await refreshJobsCache();
      await Promise.all([loadKPIsAndCharts(), loadJobs(1), loadEmployers(1), loadApplications(1)]);
      // initial route
      const key = (location.hash||'#dashboard').replace('#','');
      const map = { dashboard:'dashboardSection', jobs:'jobsSection', employers:'employersSection', applications:'applicationsSection' };
      showSection(map[key]||'dashboardSection');
    })();
  </script>
</body>
</html>
