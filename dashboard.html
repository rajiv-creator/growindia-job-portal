<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia — Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="icon" href="favicon.ico">
</head>
<body>
<nav>
  <div class="brand">GrowIndia Jobs</div>
  <div class="row">
    <a href="/" class="btn ghost">← Jobs</a>
    <button id="logoutBtn" class="btn ghost">Logout</button>
  </div>
</nav>

<div class="container">
  <h1>My Dashboard</h1>

  <div id="welcome" class="card">Loading…</div>

  <div class="card">
    <h2>My Applications</h2>
    <div class="pad" id="apps">Loading…</div>
  </div>
</div>

<footer>© GrowIndia</footer>

<!-- Scripts (order matters) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="config.js?v=8"></script>
<script src="app.js?v=8"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const logoutBtn = document.getElementById('logoutBtn');
  const welcomeEl = document.getElementById('welcome');
  const appsEl    = document.getElementById('apps');

  logoutBtn.addEventListener('click', () => sbAuth.signOut());

  // Require login
  (async function init(){
    const me = await sbAuth.currentUser();
    if (!me) { await sbAuth.openLogin(); return; }

    welcomeEl.innerHTML = `<p><strong>Hello,</strong> ${me.email}</p>`;

    // If arriving with ?apply=jobId → apply once (idempotent via unique constraint)
    const params = new URLSearchParams(location.search);
    const jobId = params.get('apply');
    if (jobId) {
      await applyToJob(jobId);
      // Clean the URL to avoid repeat applies on refresh
      params.delete('apply');
      const cleanUrl = location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, '', cleanUrl);
    }

    await loadApps();
  })();

  async function applyToJob(jobId){
    const { data: { user } } = await sb.supabase.auth.getUser();
    if (!user) return;

    // Try insert; if duplicate (job_id, applicant_id), ignore.
    const { error } = await sb.supabase
      .from('applications')
      .insert([{ job_id: jobId, applicant_id: user.id }]);

    if (error && !/duplicate key value/i.test(error.message)) {
      alert('Could not submit application: ' + error.message);
    } else {
      alert('Application submitted!');
    }
  }

  async function loadApps(){
    const { data: { user } } = await sb.supabase.auth.getUser();
    if (!user){ appsEl.textContent = 'Please log in.'; return; }

    // Only MY applications
    const a = await sb.supabase
      .from('applications')
      .select('id, job_id, status, created_at')
      .eq('applicant_id', user.id)
      .order('created_at',{ascending:false});

    if (a.error){
      appsEl.innerHTML = '<em>Error loading applications: ' + (a.error.message || '') + '</em>';
      return;
    }

    if (!a.data || a.data.length === 0){
      appsEl.innerHTML = '<em>No applications yet.</em>';
      return;
    }

    // Fetch job labels
    const jobIds = [...new Set(a.data.map(x => x.job_id))];

    // 1) Try the public view (preferred)
    let j = await sb.supabase
      .from('v_job_public')
      .select('id,title,company_name')
      .in('id', jobIds);

    // 2) Fallback to base tables if the view isn't there
    if (j.error){
      j = await sb.supabase
        .from('jobs')
        .select('id,title,companies(name)')
        .in('id', jobIds);
      if (!j.error){
        j.data = (j.data || []).map(row => ({
          id: row.id,
          title: row.title,
          company_name: row.companies?.name || ''
        }));
      }
    }

    const jobMap = new Map((j.data||[]).map(r => [r.id, r]));

    const rows = a.data.map(app => {
      const job = jobMap.get(app.job_id) || {};
      const when = new Date(app.created_at).toLocaleString();
      return `<tr>
        <td>${job.title || '(Job)'}</td>
        <td>${job.company_name || ''}</td>
        <td>${app.status}</td>
        <td>${when}</td>
        <td><button class="btn ghost" data-del="${app.id}">Withdraw</button></td>
      </tr>`;
    }).join('');

    appsEl.innerHTML = `<table>
      <thead><tr><th>Job</th><th>Company</th><th>Status</th><th>Applied</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

    // Wire withdraw buttons
    appsEl.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del');
        if (!confirm('Withdraw this application?')) return;
        const r = await sb.supabase.from('applications').delete().eq('id', id);
        if (r.error) alert(r.error.message);
        else loadApps();
      });
    });
  }
});
</script>
</body>
</html>
