<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia — Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<nav>
  <div class="brand">GrowIndia Jobs</div>
  <div class="row">
    <a href="/" class="btn ghost">← Jobs</a>
    <button id="logoutBtn" class="btn ghost">Logout</button>
  </div>
</nav>

<div class="container">
  <h1>My Dashboard</h1>

  <div id="welcome" class="card">Loading…</div>

  <div class="card">
    <h2>My Applications</h2>
    <div class="pad" id="apps">Loading…</div>
  </div>
</div>

<footer>© GrowIndia</footer>

<!-- Scripts -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="app.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const logoutBtn = document.getElementById('logoutBtn');
  const welcomeEl = document.getElementById('welcome');
  const appsEl = document.getElementById('apps');

  logoutBtn.addEventListener('click', () => sbAuth.signOut());

  // Require login
  (async function init(){
    const me = await sbAuth.currentUser();
    if (!me) { await sbAuth.openLogin(); return; }

    welcomeEl.innerHTML = `<p><strong>Hello,</strong> ${me.email}</p>`;

    // If arriving with ?apply=jobId → apply once (idempotent via unique constraint)
    const params = new URLSearchParams(location.search);
    const jobId = params.get('apply');
    if (jobId) {
      await applyToJob(jobId);
      // Clean the URL to avoid repeat applies on refresh
      params.delete('apply');
      const cleanUrl = location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, '', cleanUrl);
    }

    await loadApps();
  })();

  async function applyToJob(jobId){
    const { data: { user } } = await sb.supabase.auth.getUser();
    if (!user) return;

    // Upsert-like: try insert; on conflict (job_id, applicant_id) do nothing
    const { error } = await sb.supabase
      .from('applications')
      .insert([{ job_id: jobId, applicant_id: user.id }]);
    if (error && !/duplicate key value/i.test(error.message)) {
      alert('Could not submit application: ' + error.message);
    } else {
      alert('Application submitted!');
    }
  }

  async function loadApps(){
    const { data: { user } } = await sb.supabase.auth.getUser();
    if (!user){ appsEl.textContent = 'Please log in.'; return; }

    // Join apps → jobs (client-side join)
    const a = await sb.supabase
      .from('applications')
      .select('id, job_id, status, created_at')
      .order('created_at',{ascending:false});

    if (a.error){ appsEl.innerHTML = '<em>Error loading applications</em>'; return; }

    if (!a.data || a.data.length === 0){
      appsEl.innerHTML = '<em>No applications yet.</em>';
      return;
    }

    // Fetch the jobs for labels (batch fetch)
    const jobIds = [...new Set(a.data.map(x => x.job_id))];
    const j = await sb.supabase
      .from('v_job_public')
      .select('id,title,company_name')
      .in('id', jobIds);

    const jobMap = new Map((j.data||[]).map(r => [r.id, r]));

    const rows = a.data.map(app => {
      const job = jobMap.get(app.job_id) || {};
      const when = new Date(app.created_at).toLocaleString();
      return `<tr>
        <td>${job.title || '(Job)'}</td>
        <td>${job.company_name || ''}</td>
        <td>${app.status}</td>
        <td>${when}</td>
        <td><button class="btn ghost" data-del="${app.id}">Withdraw</button></td>
      </tr>`;
    }).join('');

    appsEl.innerHTML = `<table>
      <thead><tr><th>Job</th><th>Company</th><th>Status</th><th>Applied</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

    // Wire withdraw buttons
    appsEl.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-del');
        if (!confirm('Withdraw this application?')) return;
        const r = await sb.supabase.from('applications').delete().eq('id', id);
        if (r.error) alert(r.error.message);
        else loadApps();
      });
    });
  }
});
</script>
</body>
</html>
