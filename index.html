<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia Jobs</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<nav>
  <div class="brand">GrowIndia Jobs</div>
  <div class="row">
    <!-- Sends admins to /admin.html and everyone else to /dashboard.html -->
    <a href="#" onclick="goToDashboard(); return false;">Dashboard</a>

    <!-- Buttons are wired below via JS (no inline handlers to avoid conflicts) -->
    <button id="loginBtn" class="btn">Login / Sign up</button>
    <button id="logoutBtn" class="btn ghost" hidden>Logout</button>
  </div>
</nav>

<div class="container">
  <h1>Open Positions</h1>

  <div class="card">
    <div class="grid">
      <div><label for="q">Search</label><input id="q" placeholder="Title or company"/></div>
      <div>
        <label for="emp">Employment</label>
        <select id="emp">
          <option value="">Any</option>
          <option value="full_time">full_time</option>
          <option value="part_time">part_time</option>
          <option value="contract">contract</option>
          <option value="internship">internship</option>
        </select>
      </div>
      <div>
        <label for="rem">Remote?</label>
        <select id="rem">
          <option value="">Any</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
    </div>
  </div>

  <div id="jobs" class="grid"></div>
</div>

<footer>© GrowIndia</footer>

<!-- Load scripts ONCE in the correct order -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="app.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const jobsEl   = document.getElementById('jobs');
  const qEl      = document.getElementById('q');
  const empEl    = document.getElementById('emp');
  const remEl    = document.getElementById('rem');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn= document.getElementById('logoutBtn');

  // Hook auth buttons to helpers from app.js
  loginBtn.addEventListener('click', () => sbAuth.openLogin());
  logoutBtn.addEventListener('click', () => sbAuth.signOut());

  async function refreshAuthButtons(){
    try{
      const u = await sbAuth.currentUser();
      loginBtn.hidden  = !!u;
      logoutBtn.hidden = !u;
    }catch(_e){
      // If auth helper isn't ready yet, keep default
    }
  }

  async function loadJobs(){
    const term = (qEl.value || '').trim().toLowerCase();
    const emp  = empEl.value;
    const rem  = remEl.value;

    let q = sb.supabase
      .from('v_job_public')
      .select('*')
      .order('created_at', { ascending:false })
      .limit(100);

    if (emp) q = q.eq('employment', emp);
    if (rem) q = q.eq('is_remote', rem === 'true');

    let { data, error } = await q;

    // Fallback if the view doesn't exist
    if (error){
      const r = await sb.supabase
        .from('jobs')
        .select('*, companies(name, website)')
        .order('created_at', { ascending:false })
        .limit(100);

      data  = (r.data || []).map(j => ({
        ...j,
        company_name: j.companies?.name,
        company_website: j.companies?.website
      }));
      error = r.error;
    }

    jobsEl.innerHTML = '';
    if (error){
      jobsEl.innerHTML = '<div class="card">Error: ' + (error.message || 'Failed to load jobs') + '</div>';
      return;
    }

    const list = (data || []).filter(j =>
      !term ||
      (j.title || '').toLowerCase().includes(term) ||
      (j.company_name || '').toLowerCase().includes(term)
    );

    if (!list.length){
      jobsEl.innerHTML = '<div class="card">No jobs match.</div>';
      return;
    }

    list.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';

      const empLabel = (r.employment || '').replace(/_/g,' ');
      const sal = (r.currency ? (' • ' + r.currency) : '') +
                  (r.salary_min ? (' ' + r.salary_min) : '') +
                  (r.salary_max ? ('-' + r.salary_max) : '');

      card.innerHTML = `
        <h2>${r.title || ''}</h2>
        <div class="badge">${r.company_name || ''}</div>
        <p><small class="muted">
          ${r.location || 'Location flexible'} • ${empLabel}${sal}
        </small></p>
        <div class="row">
          <a class="btn ghost" href="dashboard.html?apply=${encodeURIComponent(r.id)}">Apply</a>
        </div>
      `;
      jobsEl.appendChild(card);
    });
  }

  // Filter listeners (right events for inputs/selects)
  qEl.addEventListener('input', loadJobs);
  empEl.addEventListener('change', loadJobs);
  remEl.addEventListener('change', loadJobs);

  refreshAuthButtons();
  loadJobs();
});
</script>
</body>
</html>
