<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia Jobs</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="app.js"></script>
</head>
<body>
<nav>
  <div class="brand">GrowIndia Jobs</div>
  <div class="row">
    <a class="btn ghost" href="dashboard.html">Dashboard</a>
    <button id="loginBtn" class="btn">Login / Sign up</button>
    <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
  </div>
</nav>

<div class="container">
  <h1>Open Positions</h1>

  <div class="card">
    <div class="grid">
      <div><label>Search</label><input id="q" placeholder="Title or company"/></div>
      <div>
        <label>Employment</label>
        <select id="emp">
          <option value="">Any</option>
          <option>full_time</option><option>part_time</option>
          <option>contract</option><option>internship</option>
        </select>
      </div>
      <div>
        <label>Remote?</label>
        <select id="rem">
          <option value="">Any</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
    </div>
  </div>

  <div id="jobs" class="grid"></div>
</div>

<footer>© GrowIndia</footer>

<script>
const jobsEl=document.getElementById('jobs'),
      qEl=document.getElementById('q'),
      empEl=document.getElementById('emp'),
      remEl=document.getElementById('rem'),
      loginBtn=document.getElementById('loginBtn'),
      logoutBtn=document.getElementById('logoutBtn');

logoutBtn.onclick=()=>sbAuth.signOut();
loginBtn.onclick=async()=>{
  const email=prompt("Enter your email");
  if(!email) return;
  try{ await sbAuth.sendMagicLink(email); alert("Magic link sent!"); }
  catch(e){ alert(e.message) }
};

async function refreshAuthButtons(){
  const u=await sbAuth.currentUser();
  loginBtn.style.display=u?'none':'inline-block';
  logoutBtn.style.display=u?'inline-block':'none';
}

async function loadJobs(){
  const term = qEl.value?.trim().toLowerCase();
  const emp  = empEl.value;
  const rem  = remEl.value;

  let q = sb.supabase.from('v_job_public').select('*').order('created_at',{ascending:false}).limit(100);
  if(emp) q = q.eq('employment', emp);
  if(rem) q = q.eq('is_remote', rem === 'true');

  let { data, error } = await q;

  // Fallback if view is missing
  if(error){
    const r = await sb.supabase.from('jobs').select('*, companies(name, website)').order('created_at',{ascending:false}).limit(100);
    data = (r.data||[]).map(j => ({...j, company_name:j.companies?.name, company_website:j.companies?.website}));
    error = r.error;
  }

  jobsEl.innerHTML='';
  if(error){ jobsEl.innerHTML = '<div class="card">Error: '+error.message+'</div>'; return }
  const list = (data||[]).filter(j =>
    !term ||
    (j.title||'').toLowerCase().includes(term) ||
    (j.company_name||'').toLowerCase().includes(term)
  );
  if(!list.length){ jobsEl.innerHTML='<div class="card">No jobs match.</div>'; return }

  list.forEach(r=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<h2>${r.title||''}</h2>
      <div class="badge">${r.company_name||''}</div>
      <p><small class="muted">${r.location||'Location flexible'} • ${(r.employment||'').replace('_',' ')}${r.currency?(' • '+r.currency):''} ${r.salary_min||''}${r.salary_max?('-'+r.salary_max):''}</small></p>
      <div class="row"><a class="btn ghost" href="dashboard.html?apply=${r.id}">Apply</a></div>`;
    jobsEl.appendChild(c);
  });
}

[qEl,empEl,remEl].forEach(el=>el.addEventListener('input', loadJobs));
refreshAuthButtons(); loadJobs();
</script>
<script src="config.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="app.js"></script>
</body>
</html>

