<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowIndia Jobs — Login</title>

  <!-- keep this exact order -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=141"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:32px;line-height:1.5}
    .wrap{max-width:480px;margin:0 auto}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    label{display:block;margin:8px 0 6px 0;font-weight:600}
    input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    button{margin-top:12px;height:40px;padding:0 14px;border-radius:10px;border:0;background:#0ea5e9;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#6b7280;font-size:14px}
    .err{color:#b91c1c}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    a{color:#0ea5e9;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:flex-end;margin-bottom:8px">
      <a class="muted" href="/jobs.html">Browse Jobs</a>
    </div>

    <h1 style="margin:0 0 6px 0">Welcome back</h1>
    <p class="muted" style="margin:0 0 16px 0">Sign in to post jobs and manage your company.</p>

    <div class="card">
      <form id="loginForm" novalidate>
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" required />

        <button id="loginBtn" type="submit">Send magic link</button>
        <p id="msg" class="muted" style="margin:10px 0 0 0"></p>
      </form>
    </div>
  </div>

  <script>
    // REQUIREMENTS:
    // - window.supabase client and window.sbAuth are created in /config.js
    // - Supabase Auth settings allow the redirect URL (see dashboard)
    (function () {
      const form = document.getElementById("loginForm");
      const btn  = document.getElementById("loginBtn");
      const msg  = document.getElementById("msg");

      // Change this ONLY if your deployed domain is different
      const PROD_REDIRECT = "https://growindia-job-portal.vercel.app/post-auth.html";
      const redirectTo = location.hostname.endsWith("vercel.app")
        ? PROD_REDIRECT
        : (location.origin + "/post-auth.html");

      if (!window.sbAuth) {
        msg.classList.add("err");
        msg.textContent = "Auth not initialised. Check config.js exports window.supabase and window.sbAuth.";
        return;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = (document.getElementById("email").value || "").trim();
        if (!email) {
          msg.classList.add("err");
          msg.textContent = "Please enter a valid email.";
          return;
        }

        btn.disabled = true;
        msg.classList.remove("err");
        msg.textContent = "Sending magic link…";

        try {
          const { error } = await window.sbAuth.signInWithOtp({
            email,
            options: { emailRedirectTo: redirectTo }
          });

          if (error) throw error;

          msg.textContent = "Check your email for the sign-in link.";
        } catch (err) {
          console.error("signInWithOtp error:", err);

          const text = String(err && err.message ? err.message : err);

          if (text.includes("Failed to fetch")) {
            // Most common: CORS / URL / key mismatch
            msg.classList.add("err");
            msg.innerHTML = "Could not reach Supabase (likely CORS / URL config). \
Ensure in Supabase → Auth → URL Configuration:\
<br>• Site URL: <code>https://growindia-job-portal.vercel.app</code>\
<br>• Redirects: <code>https://growindia-job-portal.vercel.app/post-auth.html</code> (and localhost if needed)\
<br>• Allowed Origins (CORS): your Vercel domain (and localhost)";
          } else {
            msg.classList.add("err");
            msg.textContent = "Error: " + text;
          }
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
